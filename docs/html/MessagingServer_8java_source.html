<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.5"/>
<title>Fermilab Dynamic Displays System: src/gov/fnal/ppd/dd/chat/MessagingServer.java Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Fermilab Dynamic Displays System
   &#160;<span id="projectnumber">5.3.6</span>
   </div>
   <div id="projectbrief">Fermilab&#39;s implementation of a digital signage system</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.5 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('MessagingServer_8java_source.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">MessagingServer.java</div>  </div>
</div><!--header-->
<div class="contents">
<a href="MessagingServer_8java.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="keyword">package </span>gov.fnal.ppd.dd.chat;</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment"> * MessagingServer</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment"> * Taken from the internet on 5/12/2014. @see &lt;a</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment"> * href=&quot;http://www.dreamincode.net/forums/topic/259777-a-simple-chat-program-with-clientserver-gui-optional/&quot; dreamincode.net&lt;/a&gt;</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment"> * </span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment"> * Copyright (c) 2013-15 by Fermilab Research Alliance (FRA), Batavia, Illinois, USA.</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="keyword">import</span> <span class="keyword">static</span> gov.fnal.ppd.dd.GlobalVariables.DATABASE_NAME;</div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="keyword">import</span> <span class="keyword">static</span> gov.fnal.ppd.dd.GlobalVariables.FIFTEEN_MINUTES;</div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="keyword">import</span> <span class="keyword">static</span> gov.fnal.ppd.dd.GlobalVariables.ONE_DAY;</div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="keyword">import</span> <span class="keyword">static</span> gov.fnal.ppd.dd.GlobalVariables.ONE_HOUR;</div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="keyword">import</span> <span class="keyword">static</span> gov.fnal.ppd.dd.GlobalVariables.ONE_MINUTE;</div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="keyword">import</span> <span class="keyword">static</span> gov.fnal.ppd.dd.GlobalVariables.ONE_SECOND;</div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="keyword">import</span> <span class="keyword">static</span> gov.fnal.ppd.dd.GlobalVariables.SIMPLE_RECOVERABLE_ERROR;</div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="keyword">import</span> <span class="keyword">static</span> gov.fnal.ppd.dd.GlobalVariables.TOP_LEVEL_DOMAIN;</div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="keyword">import</span> <span class="keyword">static</span> gov.fnal.ppd.dd.GlobalVariables.UNRECOVERABLE_ERROR;</div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="keyword">import</span> <span class="keyword">static</span> gov.fnal.ppd.dd.GlobalVariables.setLogger;</div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="keyword">import</span> <span class="keyword">static</span> gov.fnal.ppd.dd.util.nonguiUtils.GeneralUtilities.catchSleep;</div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="keyword">import</span> <span class="keyword">static</span> gov.fnal.ppd.dd.util.nonguiUtils.GeneralUtilities.launchMemoryWatcher;</div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="keyword">import</span> <span class="keyword">static</span> gov.fnal.ppd.dd.util.nonguiUtils.GeneralUtilities.println;</div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;</div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="keyword">import</span> java.io.BufferedReader;</div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="keyword">import</span> java.io.IOException;</div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="keyword">import</span> java.io.InputStream;</div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="keyword">import</span> java.io.InputStreamReader;</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="keyword">import</span> java.io.OutputStream;</div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="keyword">import</span> java.net.InetAddress;</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="keyword">import</span> java.net.ServerSocket;</div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="keyword">import</span> java.net.Socket;</div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="keyword">import</span> java.net.SocketTimeoutException;</div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="keyword">import</span> java.net.UnknownHostException;</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="keyword">import</span> java.sql.Connection;</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="keyword">import</span> java.sql.ResultSet;</div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="keyword">import</span> java.sql.SQLException;</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="keyword">import</span> java.sql.Statement;</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="keyword">import</span> java.text.SimpleDateFormat;</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="keyword">import</span> java.util.ArrayList;</div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="keyword">import</span> java.util.Date;</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="keyword">import</span> java.util.List;</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap;</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="keyword">import</span> java.util.concurrent.CopyOnWriteArrayList;</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;<span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="keyword">import</span> java.util.logging.FileHandler;</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;<span class="keyword">import</span> java.util.logging.Level;</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;<span class="keyword">import</span> java.util.logging.LogRecord;</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;<span class="keyword">import</span> java.util.logging.SimpleFormatter;</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;<span class="keyword">import</span> <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1db_1_1ConnectionToDatabase.html">gov.fnal.ppd.dd.db.ConnectionToDatabase</a>;</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;<span class="keyword">import</span> <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1interfaces_1_1DatabaseNotVisibleException.html">gov.fnal.ppd.dd.interfaces.DatabaseNotVisibleException</a>;</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;<span class="keyword">import</span> <a class="code" href="interfacegov_1_1fnal_1_1ppd_1_1dd_1_1util_1_1nonguiUtils_1_1JavaChangeListener.html">gov.fnal.ppd.dd.util.nonguiUtils.JavaChangeListener</a>;</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;<span class="keyword">import</span> <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1util_1_1nonguiUtils_1_1JavaVersion.html">gov.fnal.ppd.dd.util.nonguiUtils.JavaVersion</a>;</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;<span class="keyword">import</span> <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1util_1_1specific_1_1ObjectSigning.html">gov.fnal.ppd.dd.util.specific.ObjectSigning</a>;</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;<span class="keyword">import</span> <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1util_1_1version_1_1VersionInformation.html">gov.fnal.ppd.dd.util.version.VersionInformation</a>;</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;<span class="keyword">import</span> <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1MessageCarrierXML.html">gov.fnal.ppd.dd.xml.MessageCarrierXML</a>;</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;<span class="keyword">import</span> <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1MyXMLMarshaller.html">gov.fnal.ppd.dd.xml.MyXMLMarshaller</a>;</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;<span class="keyword">import</span> <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1SubscriptionSubject.html">gov.fnal.ppd.dd.xml.SubscriptionSubject</a>;</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;<span class="keyword">import</span> <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1messages_1_1AreYouAliveMessage.html">gov.fnal.ppd.dd.xml.messages.AreYouAliveMessage</a>;</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;<span class="keyword">import</span> <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1messages_1_1ChangeChannelReply.html">gov.fnal.ppd.dd.xml.messages.ChangeChannelReply</a>;</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;<span class="keyword">import</span> <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1messages_1_1EmergencyMessXML.html">gov.fnal.ppd.dd.xml.messages.EmergencyMessXML</a>;</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;<span class="keyword">import</span> <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1messages_1_1ErrorMessage.html">gov.fnal.ppd.dd.xml.messages.ErrorMessage</a>;</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;<span class="keyword">import</span> <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1messages_1_1LoginMessage.html">gov.fnal.ppd.dd.xml.messages.LoginMessage</a>;</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;<span class="keyword">import</span> <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1messages_1_1WhoIsInMessage.html">gov.fnal.ppd.dd.xml.messages.WhoIsInMessage</a>;</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;<span class="keyword">import</span> <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1messages_1_1YesIAmAliveMessage.html">gov.fnal.ppd.dd.xml.messages.YesIAmAliveMessage</a>;</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;</div>
<div class="line"><a name="l00175"></a><span class="lineno"><a class="line" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html">  175</a></span>&#160;<span class="keyword">public</span> <span class="keyword">class </span><a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html">MessagingServer</a> <span class="keyword">implements</span> <a class="code" href="interfacegov_1_1fnal_1_1ppd_1_1dd_1_1util_1_1nonguiUtils_1_1JavaChangeListener.html">JavaChangeListener</a> {</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keywordtype">boolean</span>      showAliveMessages               = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keywordtype">boolean</span>      showAllIncomingMessages         = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keywordtype">int</span>    MAX_STATUS_MESSAGE_SIZE         = 4196;</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;</div>
<div class="line"><a name="l00186"></a><span class="lineno"><a class="line" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#a738da0a18944421491268d2220a3c7a4">  186</a></span>&#160;    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String  <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#a738da0a18944421491268d2220a3c7a4">SPECIAL_SERVER_MESSAGE_USERNAME</a> = <span class="stringliteral">&quot;Server Message&quot;</span>;</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;</div>
<div class="line"><a name="l00188"></a><span class="lineno"><a class="line" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#abb85ff8b189da86dfc20bd3313ea79d6">  188</a></span>&#160;    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keywordtype">int</span>  <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#abb85ff8b189da86dfc20bd3313ea79d6">MAX_CONSECUTIVE_UNPONGED_PINGS</a>  = 10;</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keywordtype">int</span>          myDB_ID                         = 0;</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;    <span class="comment">/*************************************************************************************************************************</span></div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;<span class="comment">     * Handle the communications with a specific client in the messaging system. One instance of this thread will run for each</span></div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;<span class="comment">     * client.</span></div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;<span class="comment">     * </span></div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;<span class="comment">     * This class the surrounding MessagingServer class by calling logger.fine() and by manipulating the list, al.</span></div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;<span class="comment">     * </span></div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;<span class="comment">     * Style note: Using the syntax, &quot;this.attribute&quot; within this inner class to mark the stuff owned by this class. I also tried</span></div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;<span class="comment">     * marking the surrounding calls with &quot;MessagingServer.this.&quot;, but this was just too much clutter (IMHO).</span></div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;<span class="comment">     * </span></div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;<span class="comment">     * @author Elliott McCrory, Fermilab AD/Instrumentation</span></div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;<span class="comment">     */</span></div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;    <span class="keyword">private</span> <span class="keyword">class </span>ClientThread <span class="keyword">extends</span> Thread {</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;        <span class="comment">// the only types of message we will deal with here</span></div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;        <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1MessageCarrierXML.html">MessageCarrierXML</a>           cm;</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;        <span class="comment">// the date I connected</span></div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;        <span class="comment">// String dateString;</span></div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;        Date                        creationDate;</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;        <span class="comment">// my unique id (easier for disconnection)</span></div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;        <span class="keywordtype">int</span>                         id;</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;        <span class="comment">// When was this client last seen?</span></div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;        <span class="keywordtype">long</span>                        lastSeen            = System.currentTimeMillis();</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;        <span class="comment">// If this client has been absent for too long, we put it &quot;on notice&quot;</span></div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;        <span class="keywordtype">boolean</span>                     onNotice            = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;        <span class="keywordtype">int</span>                         numOutstandingPings = 0;</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;        <span class="comment">// the input stream for our conversation</span></div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;        <span class="keyword">protected</span> InputStream       sInput;</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;        <span class="keyword">protected</span> BufferedReader    receiver;</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;        <span class="comment">// the output stream for our conversation</span></div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;        <span class="keyword">protected</span> OutputStream      sOutput;</div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;        <span class="comment">// the socket where to listen/talk</span></div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;        Socket                      socket;</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;        <span class="comment">// Does it seem like the socket for this client is active?</span></div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;        <span class="keywordtype">boolean</span>                     thisSocketIsActive  = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;        <span class="comment">// the Username of the Client</span></div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;        String                      username;</div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;        <span class="keyword">private</span> InetAddress         theIPAddress;</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;        <span class="keyword">private</span> Thread              myShutdownHook;</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;        ClientThread(Socket socket) {</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;            super(<span class="stringliteral">&quot;ClientThread_of_MessagingServer_&quot;</span> + <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html">MessagingServer</a>.uniqueId);</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;            <span class="comment">// a unique id</span></div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;            this.id = MessagingServer.uniqueId.getAndIncrement();</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;            this.socket = socket;</div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;            <span class="keyword">final</span> <span class="keywordtype">int</span> initialID = this.id;</div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;            this.myShutdownHook = <span class="keyword">new</span> Thread(<span class="stringliteral">&quot;ShutdownHook_of_MessagingServer_&quot;</span> + <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html">MessagingServer</a>.uniqueId) {</div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;                <span class="keyword">public</span> <span class="keywordtype">void</span> run() {</div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;                    println(ClientThread.class, <span class="stringliteral">&quot;Shutdown hook called to shutdown client, initialID=&quot;</span> + initialID + <span class="stringliteral">&quot;, final ID=&quot;</span></div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;                            + ClientThread.this.id);</div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;                    close(<span class="keyword">true</span>);</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;                }</div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;            };</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;            Runtime.getRuntime().addShutdownHook(this.myShutdownHook);</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;            theIPAddress = socket.getInetAddress();</div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;        }</div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;</div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;        <span class="keyword">public</span> <span class="keywordtype">void</span> initialize() {</div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;            <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1MessageCarrierXML.html">MessageCarrierXML</a> read = null;</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;            <span class="comment">/* Creating both Data Stream */</span></div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;            logger.fine(<span class="stringliteral">&quot;Starting client thread at uniqueID=&quot;</span> + <span class="keywordtype">id</span> + <span class="stringliteral">&quot; connected to &quot;</span> + theIPAddress + <span class="stringliteral">&quot;, port &quot;</span></div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;                    + socket.getLocalPort() + <span class="stringliteral">&quot;, remote port &quot;</span> + socket.getPort());</div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;            <span class="keywordtype">boolean</span> probablePortScanner = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;            <span class="keywordflow">if</span> (theIPAddress.toString().contains(<span class="stringliteral">&quot;131.225.12.&quot;</span>) || theIPAddress.toString().contains(<span class="stringliteral">&quot;0:0:0:0:0:0:&quot;</span>)) {</div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;                <span class="comment">// Well, at Fermilab, this is a port scanner. It would be cheating to ignore these requests altogether since</span></div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;                <span class="comment">// this is an assumption here (that is, if the suite goes elsewhere, or they change their addressing, this shield</span></div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;                <span class="comment">// will not help). So we really need to figure out how to withstand these probes.</span></div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;                probablePortScanner = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;            }</div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;            <span class="keywordtype">int</span> socketTimeout = 10 * ((int) ONE_SECOND);</div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;</div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;            <span class="keywordflow">try</span> {</div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;                <span class="comment">/*</span></div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;<span class="comment">                 * FIXME ??? --- On June 2, 2015, 15:16:33 (approximately) I connected a display server with a mixed-up IP address.</span></div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;<span class="comment">                 * Its internal reckoning of its IP address was different from what DNS said. I was able to connect to the server</span></div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;<span class="comment">                 * (and this is the spot where that connection happens on the server), and everything seemed to work. However, at</span></div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;<span class="comment">                 * that precise moment, the messaging server lost track of ALL of its clients, and all the clients lost track of the</span></div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;<span class="comment">                 * server. I do not see how this could have happened, unless it is something within the &quot;socket&quot; mechanism of Java.</span></div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;<span class="comment">                 * So, future self, be warned that this could happen again and foul everything up.</span></div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;<span class="comment">                 */</span></div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;                socket.setSoTimeout(socketTimeout);</div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;                <span class="comment">// create output first</span></div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;                this.sOutput = socket.getOutputStream();</div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;                this.sInput = socket.getInputStream();</div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;                this.receiver = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(sInput));</div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;                <span class="keywordflow">if</span> (probablePortScanner)</div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;                    logger.fine(<span class="stringliteral">&quot;First call to MessageConveyor.getNextDocument(), local port=&quot;</span> + this.socket.getLocalPort());</div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;</div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;                <span class="comment">// Consider this: Maybe we only accept connections from IP addresses we know, from looking inside the database.</span></div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;                <span class="comment">// Only Displays and Controllers can and may connect.</span></div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;</div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;                <span class="comment">// This message MUST be a login message that comes immediately.</span></div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;                read = MessageConveyor.getNextDocument(getClass(), receiver, <span class="stringliteral">&quot; (new connection, client ID=&quot;</span> + this.id + <span class="stringliteral">&quot;)&quot;</span>);</div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;</div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;                <span class="comment">// Whew! Got through the first read, so wait forever on subsequent ones.</span></div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;                socket.setSoTimeout(0);</div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;</div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;                <span class="keywordflow">if</span> (probablePortScanner)</div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;                    logger.fine(<span class="stringliteral">&quot;Got a document from MessageConveyor.getNextDocument() of type &quot;</span></div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;                            + read.getMessageValue().getClass().getCanonicalName());</div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;</div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;                <span class="keywordflow">if</span> (!(read.<a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1MessageCarrierXML.html#acd02da5d8151d98e634df355e0525d00">getMessageValue</a>() instanceof <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1messages_1_1LoginMessage.html">LoginMessage</a>)) {</div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;                    logger.warning(<span class="stringliteral">&quot;Expected &quot;</span> + LoginMessage.class.getCanonicalName() + <span class="stringliteral">&quot; message &quot;</span> + read.<a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1MessageCarrierXML.html#acd02da5d8151d98e634df355e0525d00">getMessageValue</a>()</div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;                            + <span class="stringliteral">&quot;, but got a &quot;</span> + read.getMessageValue().getClass().getCanonicalName() + <span class="stringliteral">&quot; message&quot;</span>);</div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;                    close();</div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;                    <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;                }</div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;                <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1messages_1_1LoginMessage.html">LoginMessage</a> lm = (<a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1messages_1_1LoginMessage.html">LoginMessage</a>) read.<a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1MessageCarrierXML.html#acd02da5d8151d98e634df355e0525d00">getMessageValue</a>();</div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;                String un = lm.getClient().getName();</div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;                this.username = un + <span class="stringliteral">&quot;_&quot;</span> + id;</div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;                logger.fine(<span class="stringliteral">&quot;&#39;&quot;</span> + this.username + <span class="stringliteral">&quot;&#39; has connected.&quot;</span>);</div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;                setName(<span class="stringliteral">&quot;ClientThread_of_MessagingServer_&quot;</span> + username);</div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;                this.creationDate = <span class="keyword">new</span> Date();</div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;            } <span class="keywordflow">catch</span> (<a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1UnrecognizedCommunicationException.html">UnrecognizedCommunicationException</a> e) {</div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;                logger.warning(<span class="stringliteral">&quot;We have a potential client that is not behaving properly.  We will try to ignore it. &quot;</span></div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;                        + <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#afe655a915ee116333ee6f1c8331b7929">exceptionString</a>(e));</div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;                close();</div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;            } <span class="keywordflow">catch</span> (SocketTimeoutException e) {</div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;                logger.warning(</div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;                        <span class="stringliteral">&quot;We have a potential client that did not immediately respond to a connection.  We will try to ignore it. &quot;</span></div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;                                + <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#afe655a915ee116333ee6f1c8331b7929">exceptionString</a>(e));</div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;                close();</div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;            } <span class="keywordflow">catch</span> (Exception e) {</div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;                <span class="comment">// Usually, it seems we fall here when something tries to connect to us but is not one of the Java clients.</span></div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;                <span class="comment">// At Fermilab, this happens when this port gets scanned.</span></div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;                logger.warning(<span class="stringliteral">&quot;Exception creating new Input/output streams on socket (&quot;</span> + socket + <span class="stringliteral">&quot;) due to this exception: &quot;</span></div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;                        + <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#afe655a915ee116333ee6f1c8331b7929">exceptionString</a>(e));</div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;                <span class="comment">// e.printStackTrace();</span></div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;                close();</div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;            }</div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;            <span class="comment">// this.dateString = date.toString();</span></div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;        }</div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;</div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;        <span class="comment">// try to close everything</span></div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;        <span class="keyword">protected</span> <span class="keywordtype">void</span> close() {</div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;            close(<span class="keyword">false</span>);</div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;        }</div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;</div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;        <span class="keyword">protected</span> <span class="keywordtype">void</span> close(<span class="keywordtype">boolean</span> duringShutdown) {</div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;            String progress = <span class="stringliteral">&quot;&quot;</span>;</div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;            <span class="keywordflow">try</span> {</div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;                logger.fine(<span class="stringliteral">&quot;Closing client &quot;</span> + username);</div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;                thisSocketIsActive = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;                numClosedCallsSeen++;</div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;                <span class="keywordflow">try</span> {</div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;                    <span class="keywordflow">if</span> (this.sOutput != null) {</div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;                        this.sOutput.close();</div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;                        progress += <span class="stringliteral">&quot; Closed sOutput.&quot;</span>;</div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;                    }</div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;                } <span class="keywordflow">catch</span> (Exception e) {</div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;                    logger.warning(<a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#afe655a915ee116333ee6f1c8331b7929">exceptionString</a>(e));</div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;                    progress += <span class="stringliteral">&quot; Problems closing sOutput.&quot;</span>;</div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;                }</div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;                <span class="keywordflow">try</span> {</div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;                    <span class="keywordflow">if</span> (this.sInput != null) {</div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;                        this.sInput.close();</div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;                        progress += <span class="stringliteral">&quot; Closed sInput.&quot;</span>;</div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;                    }</div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;                } <span class="keywordflow">catch</span> (Exception e) {</div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;                    logger.warning(<a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#afe655a915ee116333ee6f1c8331b7929">exceptionString</a>(e));</div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;                    progress += <span class="stringliteral">&quot; Problems closing sInput.&quot;</span>;</div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;                }</div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;                <span class="keywordflow">try</span> {</div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;                    <span class="keywordflow">if</span> (this.socket != null) {</div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;                        this.socket.close();</div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;                        progress += <span class="stringliteral">&quot; Closed socket.&quot;</span>;</div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;                    }</div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;                } <span class="keywordflow">catch</span> (Exception e) {</div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;                    logger.warning(<a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#afe655a915ee116333ee6f1c8331b7929">exceptionString</a>(e));</div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;                    progress += <span class="stringliteral">&quot; Problems closing socket.&quot;</span>;</div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;                }</div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;                this.sInput = null;</div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;                this.sOutput = null;</div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;                this.socket = null;</div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;</div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;                <span class="keywordflow">if</span> (!duringShutdown &amp;&amp; this.myShutdownHook != null) {</div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;                    Runtime.getRuntime().removeShutdownHook(this.myShutdownHook);</div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;                    this.myShutdownHook = null;</div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;                    progress += <span class="stringliteral">&quot; Removed shutdown hook.&quot;</span>;</div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;                } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;                    progress += <span class="stringliteral">&quot; No shutdown hook to remove.&quot;</span>;</div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;                }</div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;            } <span class="keywordflow">catch</span> (Exception e) {</div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;                logger.warning(<a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#afe655a915ee116333ee6f1c8331b7929">exceptionString</a>(e));</div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;            }</div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;            logger.fine(<span class="stringliteral">&quot;Closed client &quot;</span> + username + <span class="stringliteral">&quot;:&quot;</span> + progress);</div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;        }</div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;</div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;        <span class="keyword">public</span> <span class="keywordtype">long</span> getLastSeen() {</div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;            <span class="keywordflow">return</span> this.lastSeen;</div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;        }</div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;</div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;        <span class="keyword">public</span> <span class="keywordtype">void</span> setLastSeen() {</div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;            this.lastSeen = System.currentTimeMillis();</div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;            setOnNotice(<span class="keyword">false</span>);</div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;            resetNumOutstandingPings();</div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;        }</div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;</div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;        <span class="keyword">public</span> <span class="keywordtype">void</span> run() {</div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;            <span class="comment">// to loop until LOGOUT or we hit an unrecoverable exception</span></div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;            <span class="comment">// Bug fix for input and output objects: call &quot;reset&quot; after every read and write to not let these objects</span></div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;            <span class="comment">// remember their state. After a few hours, we run out of memory!</span></div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;</div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;            <span class="comment">// This block of code is continuing to make problems (7/17/2015). One way to handle it is to simplify it</span></div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;            <span class="comment">// somehow. There is a lot of diagnostics mixed in with the processing. Maybe I need to pull that out in some way.</span></div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;            <span class="comment">// Bottom line: Simplify!!</span></div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;</div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;            this.thisSocketIsActive = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;            <span class="keywordflow">while</span> (this.thisSocketIsActive) {</div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;                <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1MessageCarrierXML.html">MessageCarrierXML</a> read = null;</div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;                <span class="keywordflow">try</span> {</div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;                    this.cm = read = MessageConveyor.getNextDocument(getClass(), receiver, username);</div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;                    setLastSeen();</div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;                    <span class="keywordflow">if</span> (showAllIncomingMessages)</div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;                        logger.fine(<span class="stringliteral">&quot;MessagingServer.ClientThread: Got message: &quot;</span> + cm);</div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;</div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;                    <span class="comment">// Idiot check: (Rarely seen, and never seen if the &quot;username&quot; is not null)</span></div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;                    <span class="keywordflow">if</span> (!<a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1MessageCarrierXML.html">MessageCarrierXML</a>.<a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1MessageCarrierXML.html#a04d65b843d37b0e9f2e8026ec00b95ff">isUsernameMatch</a>(username, cm.getMessageOriginator()))</div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;                        logger.warning(<span class="stringliteral">&quot;Oops (a).  My assumption is wrong.  This thread is for &#39;&quot;</span> + username</div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;                                + <span class="stringliteral">&quot;&#39; and the from field on the message is &#39;&quot;</span> + cm.getMessageOriginator() + <span class="stringliteral">&quot;&#39;&quot;</span>);</div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;</div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;                    <span class="keywordflow">if</span> (!read.<a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1MessageCarrierXML.html#a9ab80285c3975daf5032897069ed0b80">isReadOnly</a>()) {</div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;                        <span class="keywordflow">if</span> (read.<a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1MessageCarrierXML.html#a1b006e6ae04358ab235244fe4a4fbfdf">isSignatureValid</a>()) {</div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;                            logger.fine(<span class="stringliteral">&quot;Message is properly signed: &quot;</span> + this.cm);</div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;                        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;                            logger.warning(<span class="stringliteral">&quot;Message is NOT PROPERLY SIGNED: [&quot;</span> + this.cm</div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;                                    + <span class="stringliteral">&quot;]; -- ignoring this message and sending an error message back to the client.&quot;</span>);</div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;</div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;                            System.out.println(<span class="stringliteral">&quot;(((( Improperly signed message is this:\n&quot;</span> + read + <span class="stringliteral">&quot;\n))))&quot;</span>);</div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;</div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;                            <span class="comment">// Reply to the client that this message was rejected!</span></div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;                            writeUnsignedMsg(<a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1MessageCarrierXML.html">MessageCarrierXML</a>.<a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1MessageCarrierXML.html#a5159aef548c8c4fe564adc7d7d622305">getErrorMessage</a>(<a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#a738da0a18944421491268d2220a3c7a4">SPECIAL_SERVER_MESSAGE_USERNAME</a>,</div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;                                    <span class="keyword">this</span>.cm.getMessageOriginator(), <span class="stringliteral">&quot;The message to display &#39;&quot;</span> + this.cm.getMessageRecipient()</div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;                                            + <span class="stringliteral">&quot;&#39; does not have a correct cryptographic signature; it has been rejected.&quot;</span>));</div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;                            <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;                        }</div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;                    }</div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;                } <span class="keywordflow">catch</span> (Exception e) {</div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;                    String dis = e.getClass().getName() + <span class="stringliteral">&quot;, Message=[&quot;</span> + e.getMessage() + <span class="stringliteral">&quot;], client=&quot;</span> + this.username + <span class="stringliteral">&quot; &quot;</span>;</div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;                    logger.warning(dis + <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#afe655a915ee116333ee6f1c8331b7929">exceptionString</a>(e));</div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;</div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;                    <span class="comment">// Make all the other incoming messages wait until the processing here is done.</span></div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;                    <span class="keywordflow">if</span> (read == null) {</div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;                        String mes = <span class="stringliteral">&quot;The reading of the input stream produced a null object. Client: &quot;</span> + this.username;</div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;                        logger.warning(mes);</div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;                    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;                        dis = <span class="stringliteral">&quot;Client &quot;</span> + this.username + <span class="stringliteral">&quot;: Exception reading input stream -- &quot;</span> + e + <span class="stringliteral">&quot;;\n          &quot;</span></div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;                                + <span class="stringliteral">&quot;The received message was &#39;&quot;</span> + read + <span class="stringliteral">&quot;&#39;\n          (type=&quot;</span> + read.getClass().getCanonicalName()</div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;                                + <span class="stringliteral">&quot;)&quot;</span>;</div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;</div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;                        String frm = <span class="stringliteral">&quot;null&quot;</span>;</div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;                        String typ = <span class="stringliteral">&quot;null&quot;</span>;</div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;                        String tto = <span class="stringliteral">&quot;null&quot;</span>;</div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;                        <span class="keywordflow">if</span> (this.cm != null) {</div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;                            frm = this.cm.getMessageOriginator();</div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;                            typ = this.cm.getMessageValue().toString();</div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;                            tto = this.cm.getMessageRecipient();</div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;                        }</div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;                        <span class="comment">// Reply to the client that this message was rejected!</span></div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;                        String errorMessage = <span class="stringliteral">&quot;Your message of type &quot;</span> + typ + <span class="stringliteral">&quot; to client, &quot;</span> + tto</div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;                                + <span class="stringliteral">&quot; was not processed because there was an internal error in the messaging server; exception type is &quot;</span></div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;                                + e.getClass().getCanonicalName();</div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;                        logger.fine(<span class="stringliteral">&quot;Sending error message to client: [[[&quot;</span> + errorMessage + <span class="stringliteral">&quot;]]]&quot;</span>);</div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;                        <span class="keywordflow">if</span> (!frm.equals(<span class="stringliteral">&quot;null&quot;</span>))</div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;                            writeUnsignedMsg(<a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1MessageCarrierXML.html">MessageCarrierXML</a>.<a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1MessageCarrierXML.html#a5159aef548c8c4fe564adc7d7d622305">getErrorMessage</a>(<a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#a738da0a18944421491268d2220a3c7a4">SPECIAL_SERVER_MESSAGE_USERNAME</a>, frm, errorMessage));</div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;                    }</div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;                    <span class="keywordflow">break</span>; <span class="comment">// End the while(this.thisSocketIsActive) loop</span></div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;</div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;                    <span class="comment">/*</span></div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;<span class="comment">                     * There is something odd going on here. Nov. 12, 2014 (continues on Dec. 19, 2014)</span></div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;<span class="comment">                     * </span></div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;<span class="comment">                     * It seems that every time a lot of clients try to connect at once, for example when a new instance of the</span></div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;<span class="comment">                     * ChannelSelector comes up, this causes all of the existing connections to read an &quot;EOF&quot; here (sometimes worse,</span></div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;<span class="comment">                     * but it seems to mostly be EOF). Everything recovers (as it is designed to do), but this is a bug waiting to</span></div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;<span class="comment">                     * bite us harder. Some say that EOF is ignorable, but others say &quot;No way!&quot; For example:</span></div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;<span class="comment">                     * </span></div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;<span class="comment">                     * http://stackoverflow.com/questions/12684072/eofexception-when-reading-files-with-objectinputstream</span></div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;<span class="comment">                     */</span></div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;                } <span class="comment">// ----- End of &quot;try&quot; block overseeing the read, this time, of the socket -----</span></div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;</div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;                <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#a6847562b2441991b550f7b3cb7fe8f2d">totalMesssagesHandled</a>++;</div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;</div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;                Class&lt;?&gt; clazz = this.cm.getMessageValue().getClass();</div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;                <span class="keywordflow">if</span> (clazz.equals(<a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1messages_1_1AreYouAliveMessage.html">AreYouAliveMessage</a>.class)</div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;                        &amp;&amp; SPECIAL_SERVER_MESSAGE_USERNAME.equals(this.cm.getMessageRecipient())) {</div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;                    <span class="keywordflow">if</span> (showAliveMessages)</div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;                        logger.fine(<span class="stringliteral">&quot;Alive msg: &quot;</span> + cm.getMessageOriginator().trim().replace(<span class="stringliteral">&quot;.&quot;</span> + TOP_LEVEL_DOMAIN, <span class="stringliteral">&quot;&quot;</span>));</div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;                    <span class="keywordflow">continue</span>; <span class="comment">// That&#39;s all for this while-loop iteration. Go read the socket again...</span></div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;                }</div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;</div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;                <span class="keywordflow">if</span> (showAllIncomingMessages)</div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;                    logger.fine(<span class="stringliteral">&quot;MessagingServer.ClientThread: Got message of type &quot;</span> + clazz + <span class="stringliteral">&quot;: &quot;</span> + cm);</div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;</div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;                <span class="keywordflow">if</span> (clazz.equals(<a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1messages_1_1YesIAmAliveMessage.html">YesIAmAliveMessage</a>.class) || clazz.equals(ErrorMessage.class)</div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;                        || clazz.equals(<a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1messages_1_1ChangeChannelReply.html">ChangeChannelReply</a>.class)) {</div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;                    broadcast(this.cm);</div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (clazz.equals(<a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1messages_1_1LoginMessage.html">LoginMessage</a>.class)) {</div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;                    logger.fine(this.username + <span class="stringliteral">&quot; disconnected with a LOGOUT message.&quot;</span>);</div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;                    this.thisSocketIsActive = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;                    numLogoutsSeen++;</div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (clazz.equals(<a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1messages_1_1WhoIsInMessage.html">WhoIsInMessage</a>.class)) {</div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;                    <span class="comment">// writeMsg(&quot;WHOISIN List of the users connected at &quot; + sdf.format(new Date()) + &quot;\n&quot;);</span></div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;                    <span class="comment">// scan all the users connected</span></div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;                    <span class="keywordtype">boolean</span> purge = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;                    <span class="comment">// The iterator (implicitly used here) makes a thread-safe copy of the list prior to traversing it.</span></div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;                    <span class="comment">// logger.fine(&quot;Responding to WhoIsIn message with data from &quot; + listOfMessagingClients.size() + &quot; clients&quot;);</span></div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;                    <span class="keywordflow">for</span> (ClientThread ct : listOfMessagingClients) {</div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;                        <span class="keywordflow">if</span> (ct != null &amp;&amp; ct.username != null &amp;&amp; ct.creationDate != null) {</div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;</div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;                            <span class="comment">// This message comes from the server, who is acting on behalf of the client to say that it is alive.</span></div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;                            <span class="comment">// This is not right in the context of signed messages--the server does not know how to sign this</span></div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;                            <span class="comment">// message properly.</span></div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;                            <span class="comment">//</span></div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;                            <span class="comment">// A correct way to do this is to have the client (the one asking &quot;WhoIsIn&quot;) to send a</span></div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;                            <span class="comment">// &quot;ping&quot; type message to the server, which it will relay to every client it knows about.</span></div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;                            <span class="comment">//</span></div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;                            <span class="comment">// The way we are doing it here (which is not strictly correct) is to send unsigned messages</span></div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;                            <span class="comment">// back to the client (the one asking &quot;WhoIsIn&quot;) for each client out there.</span></div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;</div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;                            <span class="comment">// logger.fine(&quot;Responding with &#39;YesIAmAlive&#39; message to &quot; + this.cm.getMessageOriginator() + &quot; from &quot; +</span></div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;                            <span class="comment">// ct.username);</span></div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;</div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;                            writeUnsignedMsg(<a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1MessageCarrierXML.html">MessageCarrierXML</a>.<a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1MessageCarrierXML.html#a905ca8052d9b8bb961c6e267c1e0b862">getIAmAlive</a>(ct.username, <span class="keyword">this</span>.cm.getMessageOriginator(),</div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;                                    creationDate.getTime()));</div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;                        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;                            logger.warning(<span class="stringliteral">&quot;Talking to &quot;</span> + this.username + <span class="stringliteral">&quot; socket &quot;</span> + this.socket.getLocalAddress()</div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;                                    + <span class="stringliteral">&quot;. Error!  Unexpectedly have a null client&quot;</span>);</div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;                            purge = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;                        }</div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;                    }</div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;                    <span class="keywordflow">if</span> (purge)</div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;                        <span class="keywordflow">for</span> (ClientThread CT : listOfMessagingClients) {</div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;                            <span class="keywordflow">if</span> (CT == null) {</div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;                                logger.fine(<span class="stringliteral">&quot;Removing null ClientThread&quot;</span>);</div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;                                <span class="keyword">remove</span>(CT);</div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;                                <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#a3fe04e43605b1c81c063cf9d334fb763">numRemovedNullClientThread</a>++;</div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;                            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (CT.username == null) {</div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;                                logger.fine(<span class="stringliteral">&quot;Removing ClientThread with null username [&quot;</span> + CT + <span class="stringliteral">&quot;]&quot;</span>);</div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;                                <span class="keyword">remove</span>(CT);</div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;                                CT.thisSocketIsActive = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;                                <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#a84d7bc143f1eee20c7e39ce9024783c9">numRemovedNullUsername</a>++;</div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;                            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (CT.creationDate == null) {</div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;                                logger.fine(<span class="stringliteral">&quot;Removing ClientThread with null creation date [&quot;</span> + CT + <span class="stringliteral">&quot;]&quot;</span>);</div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;                                <span class="keyword">remove</span>(CT);</div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;                                CT.thisSocketIsActive = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;                                <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#ab986fa29bcdc51bd186ad23e1c699426">numRemovedNullDate</a>++;</div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;                            }</div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;                        }</div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (clazz.equals(<a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1messages_1_1EmergencyMessXML.html">EmergencyMessXML</a>.class)) {</div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;                    <span class="keywordflow">if</span> (isAuthorized(this.cm.getMessageOriginator(), this.cm.getMessageRecipient())</div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;                            &amp;&amp; isClientAnEmergencySource(this.cm.getMessageOriginator())) {</div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;                        broadcast(<span class="keyword">this</span>);</div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;                        <span class="comment">// broadcast(this.cmSigned);</span></div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;                    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;                        String mess = <span class="stringliteral">&quot;Message rejected!  &#39;&quot;</span> + this.username + <span class="stringliteral">&quot;&#39; asked to send message of type &quot;</span> + clazz + <span class="stringliteral">&quot; to &#39;&quot;</span></div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;                                + this.cm.getMessageRecipient() + <span class="stringliteral">&quot;&#39;\n\t\tbut &quot;</span>;</div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;                        <span class="keywordflow">if</span> (isClientAnEmergencySource(this.cm.getMessageOriginator())) {</div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;                            mess += <span class="stringliteral">&quot;it is not authorized to send any sort of message to this client&quot;</span>;</div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;</div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;                        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;                            mess += <span class="stringliteral">&quot;it is not authorized to generate an emergency message&quot;</span>;</div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;                        }</div>
<div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;                        logger.warning(mess);</div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;</div>
<div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;                        <span class="comment">// Reply to the client that this message was rejected!</span></div>
<div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;                        writeUnsignedMsg(</div>
<div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;                                <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1MessageCarrierXML.html">MessageCarrierXML</a>.<a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1MessageCarrierXML.html#a5159aef548c8c4fe564adc7d7d622305">getErrorMessage</a>(<a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#a738da0a18944421491268d2220a3c7a4">SPECIAL_SERVER_MESSAGE_USERNAME</a>, <span class="keyword">this</span>.cm.getMessageOriginator(),</div>
<div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;                                        <span class="stringliteral">&quot;You are not authorized to put an emergency message on the display called &quot;</span></div>
<div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;                                                + this.cm.getMessageRecipient() + <span class="stringliteral">&quot;.\nThis directive has been rejected.&quot;</span>));</div>
<div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;                    }</div>
<div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (clazz.equals(<a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1SubscriptionSubject.html">SubscriptionSubject</a>.class)) {</div>
<div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;                    <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1SubscriptionSubject.html">SubscriptionSubject</a> subject = (<a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1SubscriptionSubject.html">SubscriptionSubject</a>) this.cm.getMessageValue();</div>
<div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;                    ClientThreadList ctl = subjectListeners.get(subject);</div>
<div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;                    <span class="keywordflow">if</span> (ctl == null) {</div>
<div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;                        ctl = <span class="keyword">new</span> ClientThreadList();</div>
<div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;                        subjectListeners.put(subject.getTopic(), ctl);</div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;                        <span class="comment">// TODO - Send this client the last message on this subject.</span></div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;                    }</div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;                    ctl.add(<span class="keyword">this</span>);</div>
<div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;                } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;                    <span class="comment">//</span></div>
<div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;                    <span class="comment">// The message, received from a client, is relayed here to the client of its choosing</span></div>
<div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;                    <span class="comment">// (unless that client is not authorized)</span></div>
<div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;                    <span class="comment">//</span></div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;                    <span class="keywordflow">if</span> (isAuthorized(this.cm.getMessageOriginator(), this.cm.getMessageRecipient())) {</div>
<div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;                        broadcast(<span class="keyword">this</span>);</div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;                        <span class="comment">// broadcast(this.cmSigned);</span></div>
<div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;                    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;                        logger.warning(<span class="stringliteral">&quot;Message rejected!  &#39;&quot;</span> + this.username + <span class="stringliteral">&quot;&#39; asked to send message of type &quot;</span></div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;                                + clazz.getSimpleName() + <span class="stringliteral">&quot; to &#39;&quot;</span> + this.cm.getMessageRecipient()</div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;                                + <span class="stringliteral">&quot;&#39;\n\t\tbut it is not authorized to send a message to this client&quot;</span>);</div>
<div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;</div>
<div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;                        <span class="comment">// Reply to the client that this message was rejected!</span></div>
<div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;                        writeUnsignedMsg(</div>
<div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;                                <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1MessageCarrierXML.html">MessageCarrierXML</a>.<a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1MessageCarrierXML.html#a5159aef548c8c4fe564adc7d7d622305">getErrorMessage</a>(<a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#a738da0a18944421491268d2220a3c7a4">SPECIAL_SERVER_MESSAGE_USERNAME</a>, <span class="keyword">this</span>.cm.getMessageOriginator(),</div>
<div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;                                        <span class="stringliteral">&quot;You are not authorized to change the channel on the display called &quot;</span></div>
<div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;                                                + this.cm.getMessageRecipient() + <span class="stringliteral">&quot;.\nThis directive has been rejected.&quot;</span>));</div>
<div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;                    }</div>
<div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;                }</div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;</div>
<div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;                <span class="comment">// TODO Add a message type of &quot;SubscribeTo&quot; and work that into the code.</span></div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;            }</div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;            <span class="comment">// remove myself from the arrayList containing the list of the connected Clients</span></div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;            logger.fine(<span class="stringliteral">&quot;Exiting CLIENT forever loop for &#39;&quot;</span> + this.username + <span class="stringliteral">&quot;&#39; (thisSocketIsActive=&quot;</span> + this.thisSocketIsActive</div>
<div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;                    + <span class="stringliteral">&quot;) Removing id=&quot;</span> + <span class="keywordtype">id</span> + <span class="stringliteral">&quot;) (This is a normal operation)&quot;</span>);</div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;</div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;            <span class="keyword">synchronized</span> (listOfMessagingClients) {</div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;                <span class="comment">// scan the array list until we found the Id</span></div>
<div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;                <span class="keywordflow">for</span> (ClientThread ct : listOfMessagingClients) {</div>
<div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;                    <span class="comment">// found it</span></div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;                    <span class="keywordflow">if</span> (ct.id == <span class="keywordtype">id</span>) {</div>
<div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;                        <span class="keyword">remove</span>(ct);</div>
<div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;                        logger.fine(<span class="stringliteral">&quot;Removed id=&quot;</span> + id);</div>
<div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;                        <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#a189ff6081d21eb1a9c98887d84e23b17">numRemovedExitedForeverLoop</a>++;</div>
<div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;                        <span class="comment">// Do not return; I want to see the information message at the end.</span></div>
<div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;                        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;                    }</div>
<div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;                }</div>
<div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;                <span class="comment">// Is it strange when control comes here? The client.id was not found in the list.</span></div>
<div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;            }</div>
<div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;</div>
<div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1util_1_1specific_1_1ObjectSigning.html">ObjectSigning</a>.<a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1util_1_1specific_1_1ObjectSigning.html#ab51a44acbc4795b78f9b608c361e9369">dropClient</a>(<span class="keyword">this</span>.username))</div>
<div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;                <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#acc91232824dd5e89347e0d8ac29abae8">logger</a>.<a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1LoggerForDebugging.html#a463354c7650543e5a0b2f6806d2dbf81">fine</a>(<span class="keyword">this</span>.getClass().getSimpleName() + <span class="stringliteral">&quot;: &#39;&quot;</span> + this.username + <span class="stringliteral">&quot;&#39; Removed from ObjectSigning cache&quot;</span>);</div>
<div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;</div>
<div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;            logger.fine(this.getClass().getSimpleName() + <span class="stringliteral">&quot;: Number of remaining clients: &quot;</span> + listOfMessagingClients.size());</div>
<div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;            close();</div>
<div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;        }</div>
<div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;</div>
<div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;        @Override</div>
<div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;        <span class="keyword">public</span> String toString() {</div>
<div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;            <span class="keywordflow">return</span> this.username + <span class="stringliteral">&quot;, socket=[&quot;</span> + socket + <span class="stringliteral">&quot;]&quot;</span>;</div>
<div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;        }</div>
<div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;</div>
<div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;        <span class="keywordtype">boolean</span> writeUnsignedMsg(<a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1MessageCarrierXML.html">MessageCarrierXML</a> msg) {</div>
<div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;            <span class="comment">// System.out.println(new Date() + &quot; &quot; + getClass().getSimpleName() + &quot;.writeUnsignedMsg() for &quot; + username</span></div>
<div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;            <span class="comment">// + &quot;: message is [&quot; + msg + &quot;]&quot;);</span></div>
<div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;            <span class="keywordflow">if</span> (socket == null) {</div>
<div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;                logger.warning(<span class="stringliteral">&quot;Socket object is null--cannot send the message &quot;</span> + msg);</div>
<div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;                <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;            }</div>
<div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;            <span class="comment">// if Client is still connected send the message to it</span></div>
<div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;            <span class="keywordflow">if</span> (!socket.isConnected() || socket.isClosed() || socket.isOutputShutdown() || socket.isInputShutdown()) {</div>
<div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;                numUnexpectedClosedSockets2++;</div>
<div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;                close();</div>
<div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;                logger.warning(<span class="stringliteral">&quot;Position 2 (failure)&quot;</span>);</div>
<div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;                <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;</div>
<div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;                <span class="comment">// ***** Important Note on the limitations of this bit of the code! *****</span></div>
<div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;</div>
<div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;                <span class="comment">/*</span></div>
<div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;<span class="comment">                 * It is not possible to detect when a client on a socket is killed due to, say, a sudden reboot. This code seems to</span></div>
<div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;<span class="comment">                 * handle all the other situations, but not the reboot one. (I tested &quot;kill -9&quot; on a client, and that seemed to be</span></div>
<div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;<span class="comment">                 * caught by this code.) See, for example, http://stackoverflow.com/questions/969866/java-detect-lost-connection</span></div>
<div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;<span class="comment">                 */</span></div>
<div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;            }</div>
<div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;</div>
<div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;            <span class="comment">// write the message to the stream</span></div>
<div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;            <span class="keywordflow">try</span> {</div>
<div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;                String theMessageString = MyXMLMarshaller.getXML(msg);</div>
<div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;                <span class="comment">// logger.fine(&quot;Sending message of type &quot; + msg.getMessageValue().getClass().getSimpleName() + &quot; to &quot; +</span></div>
<div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;                <span class="comment">// this.username);</span></div>
<div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;                <span class="keywordflow">return</span> MessageConveyor.writeToSocket(theMessageString, sOutput);</div>
<div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;</div>
<div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;            } <span class="keywordflow">catch</span> (Exception e) {</div>
<div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;                logger.warning(e.getLocalizedMessage() + <span class="stringliteral">&quot;, Error sending message to &quot;</span> + this.username + <span class="stringliteral">&quot;\n&quot;</span> + <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#afe655a915ee116333ee6f1c8331b7929">exceptionString</a>(e));</div>
<div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;            }</div>
<div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;            logger.warning(<span class="stringliteral">&quot;Position 3 (failure)&quot;</span>);</div>
<div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;        }</div>
<div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;</div>
<div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;        <span class="comment">// /**</span></div>
<div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;        <span class="comment">// * Write a signed object to the Client output stream. **THIS IS THE PREFERRED WAY TO DO IT**</span></div>
<div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;        <span class="comment">// */</span></div>
<div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;        <span class="comment">// boolean writeMsg(SignedObject signedMsg) {</span></div>
<div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;        <span class="comment">// // if Client is still connected send the message to it</span></div>
<div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;        <span class="comment">// if (!socket.isConnected()) {</span></div>
<div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;        <span class="comment">// numUnexpectedClosedSockets1++;</span></div>
<div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;        <span class="comment">// close();</span></div>
<div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;        <span class="comment">// return false;</span></div>
<div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;        <span class="comment">// }</span></div>
<div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;        <span class="comment">// // write the message to the stream</span></div>
<div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;        <span class="comment">// try {</span></div>
<div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;        <span class="comment">// sOutput.writeObject(signedMsg);</span></div>
<div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;        <span class="comment">// sOutput.reset();</span></div>
<div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;        <span class="comment">// return true;</span></div>
<div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;        <span class="comment">// }</span></div>
<div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;        <span class="comment">// // if an error occurs, do not abort just inform the user</span></div>
<div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;        <span class="comment">// catch (IOException e) {</span></div>
<div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;        <span class="comment">// logger.warning(&quot;IOException sending signed message to &quot; + this.username + &quot;\n&quot; + e + &quot;\n&quot; + exceptionString(e));</span></div>
<div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;        <span class="comment">// } catch (Exception e) {</span></div>
<div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;        <span class="comment">// logger.warning(e.getLocalizedMessage() + &quot;, Error sending signed message to &quot; + this.username + e + &quot;\n&quot;</span></div>
<div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;        <span class="comment">// + exceptionString(e));</span></div>
<div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;        <span class="comment">// }</span></div>
<div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;        <span class="comment">// return false;</span></div>
<div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;        <span class="comment">// }</span></div>
<div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;</div>
<div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;        <span class="keyword">public</span> <span class="keywordtype">boolean</span> isOnNotice() {</div>
<div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;            <span class="keywordflow">return</span> onNotice;</div>
<div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;        }</div>
<div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;</div>
<div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;        <span class="keyword">public</span> <span class="keywordtype">void</span> setOnNotice(<span class="keywordtype">boolean</span> onNotice) {</div>
<div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;            this.onNotice = onNotice;</div>
<div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;        }</div>
<div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;</div>
<div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;        <span class="keyword">public</span> <span class="keywordtype">void</span> incrementNumOutstandingPings() {</div>
<div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;            ++numOutstandingPings;</div>
<div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;        }</div>
<div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;</div>
<div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;        <span class="keyword">public</span> <span class="keywordtype">void</span> resetNumOutstandingPings() {</div>
<div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;            numOutstandingPings = 0;</div>
<div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;        }</div>
<div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;</div>
<div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;        <span class="keyword">public</span> String getRemoteIPAddress() {</div>
<div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;            String retval = socket.getRemoteSocketAddress().toString();</div>
<div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;            <span class="keywordflow">return</span> retval.substring(1, retval.indexOf(<span class="charliteral">&#39;:&#39;</span>));</div>
<div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;        }</div>
<div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;</div>
<div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;        <span class="keyword">public</span> <span class="keywordtype">boolean</span> isAuthorized(String from, String to) {</div>
<div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;            <span class="keywordflow">return</span> ObjectSigning.isClientAuthorized(from, to);</div>
<div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;        }</div>
<div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;    }</div>
<div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;</div>
<div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;    <span class="keyword">private</span> <span class="keywordtype">boolean</span> isClientAnEmergencySource(String from) {</div>
<div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;        <span class="keywordflow">return</span> ObjectSigning.getInstance().isEmergMessAllowed(from);</div>
<div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;    }</div>
<div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;</div>
<div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;    <span class="comment">/*************************************************************************************************************************</span></div>
<div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;<span class="comment">     * Simple inner class to handle the insertion of a ClientThread object into a list.</span></div>
<div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;<span class="comment">     * </span></div>
<div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;<span class="comment">     * @author Elliott McCrory, Fermilab AD/Instrumentation</span></div>
<div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;<span class="comment">     * @copyright 2014</span></div>
<div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;<span class="comment">     * </span></div>
<div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;<span class="comment">     */</span></div>
<div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;</div>
<div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;    <span class="keyword">private</span> <span class="keyword">class </span>ClientThreadList <span class="keyword">extends</span> CopyOnWriteArrayList&lt;ClientThread&gt; {</div>
<div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;</div>
<div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keywordtype">boolean</span>    REQUIRE_UNIQUE_USERNAMES    = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;</div>
<div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keywordtype">long</span>       serialVersionUID            = 2919140620801861217L;</div>
<div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;</div>
<div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;        @Override</div>
<div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;        <span class="keyword">public</span> <span class="keywordtype">boolean</span> add(ClientThread ct) {</div>
<div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;            <span class="keywordflow">if</span> (ct == null || <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#a738da0a18944421491268d2220a3c7a4">SPECIAL_SERVER_MESSAGE_USERNAME</a>.equals(ct.username))</div>
<div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;                <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;</div>
<div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;            <span class="keywordflow">if</span> (REQUIRE_UNIQUE_USERNAMES) {</div>
<div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;                <span class="keywordtype">int</span> index = 0;</div>
<div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;                <span class="keywordflow">for</span> (ClientThread CT : <span class="keyword">this</span>) {</div>
<div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;                    <span class="keywordflow">if</span> (CT == null || CT.username == null) {</div>
<div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;                        logger.fine(<span class="stringliteral">&quot;Unexpected null ClientThread at index=&quot;</span> + index + <span class="stringliteral">&quot;: [&quot;</span> + CT + <span class="stringliteral">&quot;]&quot;</span>);</div>
<div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;                        <span class="keyword">remove</span>(CT); <span class="comment">// How did THIS happen??</span></div>
<div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;                        <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#a84d7bc143f1eee20c7e39ce9024783c9">numRemovedNullUsername</a>++;</div>
<div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;                    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (CT.username.equals(ct.username)) {</div>
<div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;                        logger.fine(<span class="stringliteral">&quot;Client named &quot;</span> + ct.username + <span class="stringliteral">&quot; already in this list&quot;</span>);</div>
<div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;                        <span class="keywordflow">return</span> <span class="keyword">false</span>; <span class="comment">// Duplicate username is not allowed!</span></div>
<div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;                    }</div>
<div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;                    index++;</div>
<div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;                }</div>
<div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;            }</div>
<div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;            <span class="comment">// QUESTION -- Is a bad thing to have duplicate usernames? When/if the server directs messages to the intended user,</span></div>
<div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;            <span class="comment">// this WILL be necessary. But having a fairly anonymous clientelle works just fine.</span></div>
<div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;            <span class="comment">// BUt I am seeing bugs whereby one client restarts and the server has not dropped the old connection.</span></div>
<div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;            numConnectionsSeen++;</div>
<div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;            <span class="keywordtype">boolean</span> retval = super.add(ct);</div>
<div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;            <span class="keywordflow">if</span> (!retval) {</div>
<div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;                logger.warning(<span class="stringliteral">&quot;Adding a client named &quot;</span> + ct.username + <span class="stringliteral">&quot; gives an error from CopyOnWriteArrayList.add()&quot;</span>);</div>
<div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;            }</div>
<div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;            <span class="keywordflow">return</span> retval;</div>
<div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;        }</div>
<div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;</div>
<div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;    }</div>
<div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;</div>
<div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;<span class="comment">     * ************************************************************************************************************************</span></div>
<div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;<span class="comment">     * Begin the definition of the class MessagingServer</span></div>
<div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;<span class="comment">     * </span></div>
<div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;<span class="comment">     * Static stuff</span></div>
<div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;<span class="comment">     */</span></div>
<div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;</div>
<div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;    <span class="comment">// a unique ID for each connection. It is atomic just in case two ask to connect at the same time (we have never seen this).</span></div>
<div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;    <span class="keyword">static</span> AtomicInteger                            uniqueId                        = <span class="keyword">new</span> AtomicInteger(0);</div>
<div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;</div>
<div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;    <span class="comment">// private void markClientAsSeen(String from) {</span></div>
<div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;    <span class="comment">// for (ClientThread CT : listOfMessagingClients)</span></div>
<div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;    <span class="comment">// if (from.equals(CT.username) || CT.username.startsWith(from) || from.startsWith(CT.username)) {</span></div>
<div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;    <span class="comment">// logger.fine(&quot;Marking client &quot; + from + &quot;/&quot; + CT.username + &quot; as seen&quot;);</span></div>
<div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;    <span class="comment">// CT.setLastSeen();</span></div>
<div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;    <span class="comment">// }</span></div>
<div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;    <span class="comment">// }</span></div>
<div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;</div>
<div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;    <span class="comment">// an ArrayList to keep the list of all the Client</span></div>
<div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;    ClientThreadList                                listOfMessagingClients;</div>
<div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;</div>
<div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;    ConcurrentHashMap&lt;String, ClientThreadList&gt;     subjectListeners;</div>
<div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;</div>
<div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;    <span class="comment">// A hash of the most recent message published on each subject</span></div>
<div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;    ConcurrentHashMap&lt;String, MessageCarrierXML&gt;    lastMessage;</div>
<div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;    <span class="comment">// TODO - When a client attaches to the server, it should subscribe to subject(s). Then it will receive the last message on that</span></div>
<div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;    <span class="comment">// subject. (This is kind of the point of subject/subscribe)</span></div>
<div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;</div>
<div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;    <span class="comment">// A synchronization object</span></div>
<div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;    <span class="keyword">private</span> Object                                  broadcasting                    = <span class="stringliteral">&quot;Object 1 for Java synchronization&quot;</span>;</div>
<div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;    <span class="comment">// the boolean that will be turned of to stop the server</span></div>
<div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;    <span class="keyword">private</span> <span class="keywordtype">boolean</span>                                 keepGoing;</div>
<div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;</div>
<div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;    <span class="keyword">private</span> <span class="keywordtype">int</span>                                     numConnectionsSeen              = 0;</div>
<div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;    <span class="comment">// the port number to listen for connection</span></div>
<div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;    <span class="keyword">private</span> <span class="keywordtype">int</span>                                     port;</div>
<div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;</div>
<div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;    <span class="comment">// to display time (Also used as a synchronization object for writing messages to the local terminal/GUI</span></div>
<div class="line"><a name="l00845"></a><span class="lineno"><a class="line" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#ac727c375b30722fb0d0a88f27eb97954">  845</a></span>&#160;    <span class="keyword">protected</span> SimpleDateFormat                      <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#ac727c375b30722fb0d0a88f27eb97954">sdf</a>;</div>
<div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;    <span class="keyword">private</span> Thread                                  showClientList                  = null;</div>
<div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;    <span class="keyword">private</span> <span class="keywordtype">long</span>                                    startTime                       = System.currentTimeMillis();</div>
<div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;</div>
<div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;    <span class="comment">// &quot;Too Old Time&quot; is a minute and a half</span></div>
<div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;    <span class="keyword">private</span> <span class="keywordtype">long</span>                                    tooOldTime                      = 90 * ONE_SECOND;</div>
<div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;</div>
<div class="line"><a name="l00852"></a><span class="lineno"><a class="line" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#a6847562b2441991b550f7b3cb7fe8f2d">  852</a></span>&#160;    <span class="keyword">protected</span> <span class="keywordtype">int</span>                                   <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#a6847562b2441991b550f7b3cb7fe8f2d">totalMesssagesHandled</a>           = 0;</div>
<div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;</div>
<div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;    <span class="keyword">private</span> <span class="keywordtype">int</span>                                     numRemovedForPings1             = 0;</div>
<div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;    <span class="keyword">private</span> <span class="keywordtype">int</span>                                     numRemovedForPings2             = 0;</div>
<div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;    <span class="keyword">private</span> <span class="keywordtype">int</span>                                     numClientsPutOnNotice           = 0;</div>
<div class="line"><a name="l00857"></a><span class="lineno"><a class="line" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#ae9c73322e842357c87634a60426e5bf0">  857</a></span>&#160;    <span class="keyword">public</span> <span class="keywordtype">int</span>                                      <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#ae9c73322e842357c87634a60426e5bf0">numRemovedBadWriteSeen</a>          = 0;</div>
<div class="line"><a name="l00858"></a><span class="lineno"><a class="line" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#a3fe04e43605b1c81c063cf9d334fb763">  858</a></span>&#160;    <span class="keyword">public</span> <span class="keywordtype">int</span>                                      <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#a3fe04e43605b1c81c063cf9d334fb763">numRemovedNullClientThread</a>      = 0;</div>
<div class="line"><a name="l00859"></a><span class="lineno"><a class="line" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#a84d7bc143f1eee20c7e39ce9024783c9">  859</a></span>&#160;    <span class="keyword">public</span> <span class="keywordtype">int</span>                                      <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#a84d7bc143f1eee20c7e39ce9024783c9">numRemovedNullUsername</a>          = 0;</div>
<div class="line"><a name="l00860"></a><span class="lineno"><a class="line" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#ab986fa29bcdc51bd186ad23e1c699426">  860</a></span>&#160;    <span class="keyword">public</span> <span class="keywordtype">int</span>                                      <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#ab986fa29bcdc51bd186ad23e1c699426">numRemovedNullDate</a>              = 0;</div>
<div class="line"><a name="l00861"></a><span class="lineno"><a class="line" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#a189ff6081d21eb1a9c98887d84e23b17">  861</a></span>&#160;    <span class="keyword">public</span> <span class="keywordtype">int</span>                                      <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#a189ff6081d21eb1a9c98887d84e23b17">numRemovedExitedForeverLoop</a>     = 0;</div>
<div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;    <span class="keyword">private</span> <span class="keywordtype">int</span>                                     numRemovedDuplicateUsername     = 0;</div>
<div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;    <span class="keyword">private</span> <span class="keywordtype">int</span>                                     numClosedCallsSeen              = 0;</div>
<div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;    <span class="keyword">private</span> <span class="keywordtype">int</span>                                     numLogoutsSeen                  = 0;</div>
<div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;</div>
<div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;    <span class="keyword">private</span> <span class="keywordtype">int</span>                                     numUnexpectedClosedSockets1     = 0;</div>
<div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;    <span class="keyword">private</span> <span class="keywordtype">int</span>                                     numUnexpectedClosedSockets2     = 0;</div>
<div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;    <span class="keyword">private</span> <span class="keywordtype">int</span>                                     numDuplicateClients             = 0;</div>
<div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;    <span class="keyword">private</span> <span class="keywordtype">int</span>                                     numPortScannerAttempts          = 0;</div>
<div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;    <span class="keyword">private</span> <span class="keywordtype">int</span>                                     numberOfServerMessagesReceived  = 0;</div>
<div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;</div>
<div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;    <span class="comment">// private Object oneMessageAtATime = new String(&quot;For synchronization&quot;);</span></div>
<div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;</div>
<div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;    <span class="comment">// protected Logger logger;</span></div>
<div class="line"><a name="l00875"></a><span class="lineno"><a class="line" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#acc91232824dd5e89347e0d8ac29abae8">  875</a></span>&#160;    <span class="keyword">protected</span> <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1LoggerForDebugging.html">LoggerForDebugging</a>                    <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#acc91232824dd5e89347e0d8ac29abae8">logger</a>;</div>
<div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;</div>
<div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;    <span class="comment">// private JavaVersion javaVersion;</span></div>
<div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;</div>
<div class="line"><a name="l00884"></a><span class="lineno"><a class="line" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#a9b02c801edad834dcc2a0c96071900af">  884</a></span>&#160;    <span class="keyword">public</span> <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#a9b02c801edad834dcc2a0c96071900af">MessagingServer</a>(<span class="keywordtype">int</span> port) {</div>
<div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;        this.port = port;</div>
<div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;        JavaVersion.getInstance().addJavaChangeListener(<span class="keyword">this</span>);</div>
<div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;</div>
<div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;        <span class="keywordflow">try</span> {</div>
<div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;            <span class="comment">// logger = Logger.getLogger(MessagingServer.class.getName());</span></div>
<div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;            <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#acc91232824dd5e89347e0d8ac29abae8">logger</a> = <span class="keyword">new</span> <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1LoggerForDebugging.html">LoggerForDebugging</a>(<a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html">MessagingServer</a>.class.getName());</div>
<div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;</div>
<div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;            FileHandler fileTxt = <span class="keyword">new</span> FileHandler(<span class="stringliteral">&quot;../../log/messagingServer.log&quot;</span>);</div>
<div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;            SimpleFormatter sfh = <span class="keyword">new</span> SimpleFormatter() {</div>
<div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;                <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String format1         = <span class="stringliteral">&quot;[%1$tF %1$tT] [%2$s] %3$s %n&quot;</span>;</div>
<div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;                <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String format2         = <span class="stringliteral">&quot;---------- From Logger %3$s: ---------- %n[%1$tF %1$tT] [%2$s] %4$s %n&quot;</span>;</div>
<div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;                <span class="keyword">private</span> String              lastLoggerName  = <span class="stringliteral">&quot;&quot;</span>;</div>
<div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;</div>
<div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;                @Override</div>
<div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;                <span class="keyword">public</span> <span class="keyword">synchronized</span> String format(LogRecord record) {</div>
<div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;                    <span class="keywordflow">if</span> (lastLoggerName.equals(record.getLoggerName())) {</div>
<div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;                        <span class="keywordflow">return</span> String.format(format1, <span class="keyword">new</span> Date(record.getMillis()), record.getLevel().getLocalizedName(),</div>
<div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;                                record.getMessage());</div>
<div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;                    }</div>
<div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;                    lastLoggerName = record.getLoggerName();</div>
<div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;                    <span class="keywordflow">return</span> String.format(format2, <span class="keyword">new</span> Date(record.getMillis()), record.getLevel().getLocalizedName(),</div>
<div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;                            lastLoggerName, record.getMessage());</div>
<div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;                }</div>
<div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;</div>
<div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;            };</div>
<div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;            fileTxt.setFormatter(sfh);</div>
<div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;            logger.addHandler(fileTxt);</div>
<div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;            <span class="comment">// logger.setLevel(Level.FINE);</span></div>
<div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;            logger.setLevel(Level.FINER);</div>
<div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;            <span class="comment">// logger.setLevel(Level.FINEST);</span></div>
<div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;</div>
<div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;            setLogger(<a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#acc91232824dd5e89347e0d8ac29abae8">logger</a>.<a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1LoggerForDebugging.html#a2d1f413fb8fda0b558935ee6734cf1c5">getLogger</a>());</div>
<div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;</div>
<div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;        } <span class="keywordflow">catch</span> (Exception e) {</div>
<div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;            logger.warning(<a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#afe655a915ee116333ee6f1c8331b7929">exceptionString</a>(e));</div>
<div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;        }</div>
<div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;</div>
<div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;        <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#ac727c375b30722fb0d0a88f27eb97954">sdf</a> = <span class="keyword">new</span> SimpleDateFormat(<span class="stringliteral">&quot;dd MMM HH:mm:ss&quot;</span>);</div>
<div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;</div>
<div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;        <span class="comment">// ArrayList of the Clients</span></div>
<div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;        listOfMessagingClients = <span class="keyword">new</span> ClientThreadList();</div>
<div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;        subjectListeners = <span class="keyword">new</span> ConcurrentHashMap&lt;String, ClientThreadList&gt;();</div>
<div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;        lastMessage = <span class="keyword">new</span> ConcurrentHashMap&lt;String, MessageCarrierXML&gt;();</div>
<div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;</div>
<div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;        launchMemoryWatcher(<a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#acc91232824dd5e89347e0d8ac29abae8">logger</a>.<a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1LoggerForDebugging.html#a2d1f413fb8fda0b558935ee6734cf1c5">getLogger</a>());</div>
<div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;    }</div>
<div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;</div>
<div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;    <span class="keyword">private</span> <span class="keywordtype">void</span> broadcast(ClientThread ct) {</div>
<div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;        broadcast(ct.cm);</div>
<div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;    }</div>
<div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;</div>
<div class="line"><a name="l00945"></a><span class="lineno"><a class="line" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#ad4cb5effceeb2b11031e3cf2ec0e5939">  945</a></span>&#160;    <span class="keyword">protected</span> <span class="keywordtype">void</span> <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#ad4cb5effceeb2b11031e3cf2ec0e5939">broadcast</a>(<a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1MessageCarrierXML.html">MessageCarrierXML</a> mc) {</div>
<div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;        <span class="keyword">synchronized</span> (broadcasting) { <span class="comment">// Only send one message at a time</span></div>
<div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;</div>
<div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;            String subject = mc.getMessageRecipient();</div>
<div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;            <span class="keywordflow">if</span> (subject != null) {</div>
<div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;                <span class="keywordflow">for</span> (<span class="keywordtype">int</span> m = subject.length() - 1; m &gt;= 0; m--) {</div>
<div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;                    <span class="keywordflow">if</span> (subject.charAt(m) == <span class="charliteral">&#39;_&#39;</span>) { <span class="comment">// Find the trailing &quot;_index&quot; and remove it</span></div>
<div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;                        subject = subject.substring(0, m);</div>
<div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;                        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;                    }</div>
<div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;                }</div>
<div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;            } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;                logger.warning(getClass().getSimpleName() + <span class="stringliteral">&quot; - Unexpected null subject in a message.  Message=[&quot;</span> + mc + <span class="stringliteral">&quot;]&quot;</span>);</div>
<div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;            }</div>
<div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;            lastMessage.put(subject, mc);</div>
<div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;</div>
<div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;            ClientThreadList ctl = subjectListeners.get(subject);</div>
<div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;            <span class="keywordflow">if</span> (ctl != null) {</div>
<div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;                <span class="comment">// Write this message to this client</span></div>
<div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;                <span class="keywordflow">for</span> (ClientThread ct : ctl)</div>
<div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;                    <span class="keywordflow">if</span> (<a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1MessageCarrierXML.html">MessageCarrierXML</a>.<a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1MessageCarrierXML.html#a04d65b843d37b0e9f2e8026ec00b95ff">isUsernameMatch</a>(mc.<a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1MessageCarrierXML.html#af46fdc989fa42e3371cb942a3394b945">getMessageRecipient</a>(), ct.username))</div>
<div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;                        <span class="keywordflow">if</span> (!ct.writeUnsignedMsg(mc)) {</div>
<div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;                            <span class="keyword">remove</span>(ct);</div>
<div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;                            logger.warning(getClass().getSimpleName() + <span class="stringliteral">&quot; - broadcast() FAILED.  mc=&quot;</span> + mc);</div>
<div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;                            <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#ae9c73322e842357c87634a60426e5bf0">numRemovedBadWriteSeen</a>++;</div>
<div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;                        }</div>
<div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mc.<a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1MessageCarrierXML.html#acd02da5d8151d98e634df355e0525d00">getMessageValue</a>() instanceof <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1messages_1_1YesIAmAliveMessage.html">YesIAmAliveMessage</a>) {</div>
<div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;                <span class="comment">// We get a lot of these - ignore it</span></div>
<div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!subject.equalsIgnoreCase(<span class="stringliteral">&quot;Server Message&quot;</span>)) {</div>
<div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;                logger.warning(getClass().getSimpleName() + <span class="stringliteral">&quot; -  Hmm.  We have a message on the topic &#39;&quot;</span> + subject</div>
<div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;                        + <span class="stringliteral">&quot;&#39; but the list of clients interested in this is empty.  The message is of type &quot;</span></div>
<div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;                        + mc.<a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1MessageCarrierXML.html#acd02da5d8151d98e634df355e0525d00">getMessageValue</a>().getClass().getCanonicalName());</div>
<div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;                System.err.println(<span class="stringliteral">&quot;Subjects are:&quot;</span>);</div>
<div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;                <span class="keywordflow">for</span> (String S : subjectListeners.keySet())</div>
<div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;                    System.err.println(<span class="stringliteral">&quot;\t&quot;</span> + S);</div>
<div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;            } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;                numberOfServerMessagesReceived++;</div>
<div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;            }</div>
<div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;        }</div>
<div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;    }</div>
<div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;</div>
<div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;    <span class="keyword">private</span> <span class="keywordtype">void</span> <span class="keyword">remove</span>(<span class="keyword">final</span> ClientThread ct) {</div>
<div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;        listOfMessagingClients.remove(ct);</div>
<div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;        <span class="keywordflow">for</span> (String subject : subjectListeners.keySet()) {</div>
<div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;            ClientThreadList ctl = subjectListeners.get(subject);</div>
<div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;            <span class="keywordflow">if</span> (ctl != null) {</div>
<div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;                <span class="keywordflow">while</span> (ctl.remove(ct))</div>
<div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;                    <span class="comment">// Is it really possible that a list will contain two entries that are the same??</span></div>
<div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;                    ;</div>
<div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;            }</div>
<div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;        }</div>
<div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;        logger.fine(<span class="stringliteral">&quot;Disconnected Client &quot;</span> + ct.username + <span class="stringliteral">&quot; removed from list.&quot;</span>);</div>
<div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;    }</div>
<div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;</div>
<div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;    <span class="comment">// We have abandoned this idea in favor of java.util.logging.Logger. It is better to have the calls to</span></div>
<div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;    <span class="comment">// logger in the code since that facility writes out where it was called from.</span></div>
<div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;    <span class="comment">// /**</span></div>
<div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;    <span class="comment">// * Display a message to the console or the GUI</span></div>
<div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;    <span class="comment">// */</span></div>
<div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;    <span class="comment">// protected void logger.fine(String msg) {</span></div>
<div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;    <span class="comment">// synchronized (oneMessageAtATime) { // Only print one message at a time</span></div>
<div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;    <span class="comment">// // String time = sdf.format(new Date()) + &quot; - &quot; + msg;</span></div>
<div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;    <span class="comment">// // System.out.println(time);</span></div>
<div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;    <span class="comment">// logger.fine(msg);</span></div>
<div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;    <span class="comment">// }</span></div>
<div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;    <span class="comment">// }</span></div>
<div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;    <span class="comment">// protected void logger.warning(String msg) {</span></div>
<div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;    <span class="comment">// synchronized (oneMessageAtATime) { // Only print one message at a time</span></div>
<div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;    <span class="comment">// // String time = sdf.format(new Date()) + &quot; ERROR - &quot; + msg;</span></div>
<div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;    <span class="comment">// // System.err.println(time);</span></div>
<div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;    <span class="comment">// logger.warning(msg);</span></div>
<div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;    <span class="comment">// }</span></div>
<div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;    <span class="comment">// }</span></div>
<div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;    <span class="comment">// protected void exceptionPrint(exceptionString(Exception e) {</span></div>
<div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;    <span class="comment">// logger.warning(exceptionString(e));</span></div>
<div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;    <span class="comment">// }</span></div>
<div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;</div>
<div class="line"><a name="l01026"></a><span class="lineno"><a class="line" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#afe655a915ee116333ee6f1c8331b7929"> 1026</a></span>&#160;    <span class="keyword">protected</span> String <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#afe655a915ee116333ee6f1c8331b7929">exceptionString</a>(Exception e) {</div>
<div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;        <span class="keywordflow">if</span> (e == null)</div>
<div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;            <span class="keywordflow">return</span> <span class="stringliteral">&quot;NULL Exception!&quot;</span>;</div>
<div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;</div>
<div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;        String matchPackage = getClass().getName().substring(0, 12);</div>
<div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;        StackTraceElement[] trace = e.getStackTrace();</div>
<div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;        String retval = e.getClass().getCanonicalName() + <span class="stringliteral">&quot;: &quot;</span> + (e.getMessage() == null ? <span class="stringliteral">&quot;&quot;</span> : e.getMessage());</div>
<div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;        <span class="keywordflow">if</span> (trace != null) {</div>
<div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;            <span class="keywordflow">for</span> (StackTraceElement T : trace) {</div>
<div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;                <span class="keywordflow">if</span> (T.toString().contains(matchPackage))</div>
<div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;                    retval += <span class="stringliteral">&quot;\n\t&quot;</span> + T;</div>
<div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;                    retval += <span class="stringliteral">&quot; [.] &quot;</span>; <span class="comment">// Make the log file smaller by removing lines that are almost useless</span></div>
<div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;            }</div>
<div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;            retval += <span class="stringliteral">&quot; -- Stack trace is null!?&quot;</span>;</div>
<div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;        }</div>
<div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;        <span class="keywordflow">return</span> retval;</div>
<div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;    }</div>
<div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;</div>
<div class="line"><a name="l01046"></a><span class="lineno"><a class="line" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#af24f72f6ce9d270c33afb4032d9c968b"> 1046</a></span>&#160;    <span class="keyword">protected</span> <span class="keywordtype">void</span> <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#af24f72f6ce9d270c33afb4032d9c968b">performDiagnostics</a>(<span class="keywordtype">boolean</span> show) {</div>
<div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;        <span class="comment">// check for old clientS (using ClientThread.lastSeen)</span></div>
<div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;</div>
<div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;        String oldestName = <span class="stringliteral">&quot;&quot;</span>;</div>
<div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;        <span class="keywordtype">long</span> oldestTime = System.currentTimeMillis() + FIFTEEN_MINUTES;</div>
<div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;        <span class="keywordflow">for</span> (ClientThread CT : listOfMessagingClients) {</div>
<div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;            <span class="keywordflow">if</span> (show &amp;&amp; CT.getLastSeen() &lt; oldestTime) {</div>
<div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;                oldestTime = CT.getLastSeen();</div>
<div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;                oldestName = CT.username + <span class="stringliteral">&quot; (&quot;</span> + CT.getRemoteIPAddress() + <span class="stringliteral">&quot;, &quot;</span> + CT.id + <span class="stringliteral">&quot;), last seen &quot;</span></div>
<div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;                        + <span class="keyword">new</span> Date(CT.getLastSeen());</div>
<div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;            }</div>
<div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;            <span class="keywordflow">if</span> ((System.currentTimeMillis() - CT.getLastSeen()) &gt; tooOldTime) {</div>
<div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;</div>
<div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;                <span class="comment">// Hmm. It looks like this block of code is never executed.</span></div>
<div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;</div>
<div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;                <span class="comment">// Give this client a second chance.</span></div>
<div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;</div>
<div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;                <span class="keywordflow">if</span> (CT.isOnNotice()) {</div>
<div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;                    <span class="keyword">remove</span>(CT);</div>
<div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;                    CT.close();</div>
<div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;                    logger.fine(<span class="stringliteral">&quot;Removed Client [&quot;</span> + CT.username + <span class="stringliteral">&quot;] because its last response was more than &quot;</span></div>
<div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;                            + (tooOldTime / 1000L) + <span class="stringliteral">&quot; seconds ago: &quot;</span> + <span class="keyword">new</span> Date(CT.getLastSeen()));</div>
<div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;                    numRemovedForPings1++;</div>
<div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;                    CT = null; <span class="comment">// Not really necessary, but it makes me feel better.</span></div>
<div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;                } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;                    logger.fine(<span class="stringliteral">&quot;Client [&quot;</span> + CT.username + <span class="stringliteral">&quot;] is now &#39;on notice&#39; because its last response was more than &quot;</span></div>
<div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;                            + (tooOldTime / 1000L) + <span class="stringliteral">&quot; seconds ago: &quot;</span> + <span class="keyword">new</span> Date(CT.getLastSeen()));</div>
<div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;                    CT.setOnNotice(<span class="keyword">true</span>);</div>
<div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;                    numClientsPutOnNotice++;</div>
<div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;                }</div>
<div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;            }</div>
<div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;        }</div>
<div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;        <span class="keywordflow">if</span> (show) {</div>
<div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;            <span class="keywordtype">long</span> aliveTime = System.currentTimeMillis() - startTime;</div>
<div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;            <span class="keywordtype">long</span> days = aliveTime / ONE_DAY;</div>
<div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;            <span class="keywordtype">long</span> hours = (aliveTime % ONE_DAY) / ONE_HOUR;</div>
<div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;            <span class="keywordtype">long</span> mins = (aliveTime % ONE_HOUR) / ONE_MINUTE;</div>
<div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;            <span class="keywordtype">long</span> secs = (aliveTime % ONE_MINUTE) / ONE_SECOND;</div>
<div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;</div>
<div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;            String subjectInfo = <span class="stringliteral">&quot;*There are &quot;</span> + subjectListeners.size() + <span class="stringliteral">&quot; subjects*\n&quot;</span>;</div>
<div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;            String LL = <span class="stringliteral">&quot; listeners&quot;</span>;</div>
<div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;            String NN = <span class="stringliteral">&quot;no&quot;</span>;</div>
<div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;            <span class="keywordflow">for</span> (String subject : subjectListeners.keySet()) {</div>
<div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;                ClientThreadList ctl = subjectListeners.get(subject);</div>
<div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;                <span class="comment">/*</span></div>
<div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;<span class="comment">                 * Remove subjects that contain the string &quot;_WHO_&quot; and have no listeners. These subjects belong to ChannelSelector</span></div>
<div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;<span class="comment">                 * instances, and serve to learn who is in the system. The right way to do this would be to create a static subject</span></div>
<div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;<span class="comment">                 * that all the clients know, and then publish the nodes on the system to this subject at regular intervals. The way</span></div>
<div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;<span class="comment">                 * this is implemented, these specific subjects are never going to reappear.</span></div>
<div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;<span class="comment">                 */</span></div>
<div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;                <span class="keywordflow">if</span> (subject.contains(<span class="stringliteral">&quot;_WHO_&quot;</span>) &amp;&amp; (ctl == null || ctl.size() == 0)) {</div>
<div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;                    subjectListeners.remove(subject);</div>
<div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;                    LL = <span class="stringliteral">&quot; - removed this subject&quot;</span>;</div>
<div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;                }</div>
<div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;                subjectInfo += <span class="stringliteral">&quot;     &quot;</span> + subject + <span class="stringliteral">&quot;\t[&quot;</span> + (ctl == null ? NN : ctl.size()) + LL + <span class="stringliteral">&quot;]\n&quot;</span>;</div>
<div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;</div>
<div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;                LL = <span class="stringliteral">&quot;&quot;</span>;</div>
<div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;                NN = <span class="stringliteral">&quot;none&quot;</span>;</div>
<div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;            }</div>
<div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;            <span class="comment">// String spacesForStatus = &quot; - &quot;;</span></div>
<div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;            String message = MessagingServer.class.getSimpleName() + <span class="stringliteral">&quot; has been alive &quot;</span> + days + <span class="stringliteral">&quot;D &quot;</span> + hours + <span class="stringliteral">&quot;:&quot;</span> + mins + <span class="stringliteral">&quot;:&quot;</span></div>
<div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;                    + secs + <span class="stringliteral">&quot; (&quot;</span> + aliveTime + <span class="stringliteral">&quot; msec)&quot;</span> <span class="comment">//</span></div>
<div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;                    + <span class="stringliteral">&quot;\n         &quot;</span> + numConnectionsSeen + <span class="stringliteral">&quot; connections accepted, &quot;</span> + listOfMessagingClients.size() + <span class="stringliteral">&quot; client&quot;</span></div>
<div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;                    + (listOfMessagingClients.size() != 1 ? <span class="stringliteral">&quot;s&quot;</span> : <span class="stringliteral">&quot;&quot;</span>) + <span class="stringliteral">&quot; connected right now, &quot;</span> + <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#a6847562b2441991b550f7b3cb7fe8f2d">totalMesssagesHandled</a></div>
<div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;                    + <span class="stringliteral">&quot; messages handled&quot;</span> <span class="comment">//</span></div>
<div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;                    + <span class="stringliteral">&quot;\n         Oldest client is &quot;</span> + oldestName <span class="comment">//</span></div>
<div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;                    + <span class="stringliteral">&quot;\n         Reasons (NC = Num Clients)              Count&quot;</span> <span class="comment">//</span></div>
<div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;                    + <span class="stringliteral">&quot;\n         Num apparent port scanner connections: &quot;</span> + numPortScannerAttempts <span class="comment">//</span></div>
<div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;                    + <span class="stringliteral">&quot;\n         Number of &#39;Server Message&#39; messages:   &quot;</span> + numberOfServerMessagesReceived <span class="comment">//</span></div>
<div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;                    + <span class="stringliteral">&quot;\n         NC put &#39;on notice&#39;:                    &quot;</span> + numClientsPutOnNotice <span class="comment">//</span></div>
<div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;                    + <span class="stringliteral">&quot;\n         NC removed due to lack of response:    &quot;</span> + numRemovedForPings1 + <span class="stringliteral">&quot; &amp; &quot;</span> + numRemovedForPings2<span class="comment">//</span></div>
<div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;                    + <span class="stringliteral">&quot;\n         NC rmvd for &#39;bad write&#39;:               &quot;</span> + <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#ae9c73322e842357c87634a60426e5bf0">numRemovedBadWriteSeen</a> <span class="comment">//</span></div>
<div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;                    + <span class="stringliteral">&quot;\n         NC rmvd for &#39;null client thread&#39;:      &quot;</span> + <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#a3fe04e43605b1c81c063cf9d334fb763">numRemovedNullClientThread</a> <span class="comment">//</span></div>
<div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;                    + <span class="stringliteral">&quot;\n         NC rmvd for null username:             &quot;</span> + <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#a84d7bc143f1eee20c7e39ce9024783c9">numRemovedNullUsername</a> <span class="comment">//</span></div>
<div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;                    + <span class="stringliteral">&quot;\n         NC rmvd for null date:                 &quot;</span> + <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#ab986fa29bcdc51bd186ad23e1c699426">numRemovedNullDate</a> <span class="comment">//</span></div>
<div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;                    + <span class="stringliteral">&quot;\n         NC rmvd by exiting forever loop:       &quot;</span> + <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#a189ff6081d21eb1a9c98887d84e23b17">numRemovedExitedForeverLoop</a> <span class="comment">//</span></div>
<div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;                    + <span class="stringliteral">&quot;\n         NC rmvd for duplicate name:            &quot;</span> + numRemovedDuplicateUsername <span class="comment">//</span></div>
<div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;                    + <span class="stringliteral">&quot;\n         NC rmvd for unexpected closed sockets: &quot;</span> + numUnexpectedClosedSockets1 + <span class="stringliteral">&quot; &amp; &quot;</span></div>
<div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;                    + numUnexpectedClosedSockets2 <span class="comment">//</span></div>
<div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;                    + <span class="stringliteral">&quot;\n         NC rmvd for unexpected duplicate clients: &quot;</span> + numDuplicateClients <span class="comment">//</span></div>
<div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;                    + <span class="stringliteral">&quot;\n    &quot;</span> + subjectInfo;</div>
<div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;            logger.fine(message);</div>
<div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;        }</div>
<div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;    }</div>
<div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;</div>
<div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;    <span class="keyword">private</span> <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1util_1_1version_1_1VersionInformation.html">VersionInformation</a> versionInfo = VersionInformation.getVersionInformation();</div>
<div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;</div>
<div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160;    <span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keywordtype">void</span> updateStatus(String statusMessage) {</div>
<div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;        SimpleDateFormat sqlFormat = <span class="keyword">new</span> SimpleDateFormat(<span class="stringliteral">&quot;yyyy/MM/dd HH:mm:ss&quot;</span>);</div>
<div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;</div>
<div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;        <span class="keywordflow">try</span> {</div>
<div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;            <span class="keywordtype">long</span> uptime = System.currentTimeMillis() - startTime;</div>
<div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;            String query = <span class="stringliteral">&quot;UPDATE MessagingServerStatus SET &quot;</span> <span class="comment">//</span></div>
<div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;                    + <span class="stringliteral">&quot;Time=&#39;&quot;</span> + sqlFormat.format(<span class="keyword">new</span> Date()) + <span class="stringliteral">&quot;&#39;,&quot;</span> <span class="comment">//</span></div>
<div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160;                    + <span class="stringliteral">&quot;NumConnections=&quot;</span> + numConnectionsSeen + <span class="stringliteral">&quot;,&quot;</span> <span class="comment">//</span></div>
<div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;                    + <span class="stringliteral">&quot;NumConnected=&quot;</span> + listOfMessagingClients.size() + <span class="stringliteral">&quot;,&quot;</span> <span class="comment">//</span></div>
<div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;                    + <span class="stringliteral">&quot;MessagesHandled=&quot;</span> + <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#a6847562b2441991b550f7b3cb7fe8f2d">totalMesssagesHandled</a> + <span class="stringliteral">&quot;,&quot;</span> <span class="comment">//</span></div>
<div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;                    + <span class="stringliteral">&quot;Version=&#39;&quot;</span> + versionInfo.getVersionString() + <span class="stringliteral">&quot;&#39;,&quot;</span> <span class="comment">//</span></div>
<div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;                    + <span class="stringliteral">&quot;UpTime=&quot;</span> + uptime + <span class="stringliteral">&quot;,&quot;</span>;</div>
<div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;</div>
<div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;            String status = statusMessage.replace(<span class="stringliteral">&quot;&#39;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);</div>
<div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;</div>
<div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;            <span class="keywordflow">if</span> (status.length() &gt; MAX_STATUS_MESSAGE_SIZE) {</div>
<div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;                String extra = <span class="stringliteral">&quot; ... Unexpected excess message length of &quot;</span> + status.length()</div>
<div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;                        + <span class="stringliteral">&quot;.\nThis message has been truncated.&quot;</span>;</div>
<div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;                status = status.substring(0, MAX_STATUS_MESSAGE_SIZE - extra.length() - 2) + extra;</div>
<div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;            }</div>
<div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;</div>
<div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;            query += <span class="stringliteral">&quot;Status=&#39;&quot;</span> + status + <span class="stringliteral">&quot;&#39; WHERE MessagingServerID=&quot;</span> + myDB_ID;</div>
<div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;            Connection connection = ConnectionToDatabase.getDbConnection();</div>
<div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;</div>
<div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;            <span class="keyword">synchronized</span> (connection) {</div>
<div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;                <span class="keywordflow">try</span> (Statement stmt = connection.createStatement(); ResultSet result = stmt.executeQuery(<span class="stringliteral">&quot;USE &quot;</span> + DATABASE_NAME);) {</div>
<div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;                    <span class="keywordtype">int</span> numRows = stmt.executeUpdate(query);</div>
<div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;                    <span class="keywordflow">if</span> (numRows == 0 || numRows &gt; 1) {</div>
<div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;                        println(getClass(),</div>
<div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;                                <span class="stringliteral">&quot; Problem while updating status of Messaging Server: Expected to modify exactly one row, but  modified &quot;</span></div>
<div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;                                        + numRows + <span class="stringliteral">&quot; rows instead. SQL=&#39;&quot;</span> + query + <span class="stringliteral">&quot;&#39;&quot;</span>);</div>
<div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;                    }</div>
<div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;                    stmt.close();</div>
<div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;                } <span class="keywordflow">catch</span> (Exception ex) {</div>
<div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;                    logger.warning(<a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#afe655a915ee116333ee6f1c8331b7929">exceptionString</a>(ex));</div>
<div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;                    <span class="comment">// ex.printStackTrace();</span></div>
<div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;                }</div>
<div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;            }</div>
<div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;        } <span class="keywordflow">catch</span> (Exception e) {</div>
<div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;            logger.warning(<a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#afe655a915ee116333ee6f1c8331b7929">exceptionString</a>(e));</div>
<div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;        }</div>
<div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160;    }</div>
<div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;</div>
<div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;    <span class="comment">// Big STATIC block here, run before any class object are initialized.</span></div>
<div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;</div>
<div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;    <span class="keyword">static</span> {</div>
<div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;        Connection connection = null;</div>
<div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;        <span class="keywordflow">try</span> {</div>
<div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;            connection = ConnectionToDatabase.getDbConnection();</div>
<div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;        } <span class="keywordflow">catch</span> (DatabaseNotVisibleException e1) {</div>
<div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;            e1.printStackTrace();</div>
<div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;            System.err.println(<span class="stringliteral">&quot;\nNo connection to the Signage/Displays database.&quot;</span>);</div>
<div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;            System.exit(SIMPLE_RECOVERABLE_ERROR);</div>
<div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;        }</div>
<div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;</div>
<div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;        <span class="keyword">synchronized</span> (connection) {</div>
<div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;            <span class="comment">// Use ARM to simplify these try blocks.</span></div>
<div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;            <span class="keywordflow">try</span> (Statement stmt = connection.createStatement(); ResultSet rs1 = stmt.executeQuery(<span class="stringliteral">&quot;USE &quot;</span> + DATABASE_NAME)) {</div>
<div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;</div>
<div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;                InetAddress ip = InetAddress.getLocalHost();</div>
<div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;                String myIPName = ip.getCanonicalHostName().replace(<span class="stringliteral">&quot;.dhcp&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);</div>
<div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;</div>
<div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;                String query = <span class="stringliteral">&quot;SELECT MessagingServerID FROM MessagingServerStatus where IPName=&#39;&quot;</span> + myIPName + <span class="stringliteral">&quot;&#39;&quot;</span>;</div>
<div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;</div>
<div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;                <span class="keywordflow">try</span> (ResultSet rs2 = stmt.executeQuery(query);) {</div>
<div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;                    <span class="keywordflow">if</span> (rs2.first())</div>
<div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;                        <span class="keywordflow">while</span> (!rs2.isAfterLast()) {</div>
<div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;                            <span class="keywordflow">try</span> { <span class="comment">// Move to first returned row (there can be more than one; not sure how to deal with that yet)</span></div>
<div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;                                myDB_ID = rs2.getInt(<span class="stringliteral">&quot;MessagingServerID&quot;</span>);</div>
<div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;                                System.out.println(<span class="stringliteral">&quot;The messaging serverID is &quot;</span> + myDB_ID);</div>
<div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;                            } <span class="keywordflow">catch</span> (Exception e) {</div>
<div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;                                e.printStackTrace();</div>
<div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;                                System.exit(UNRECOVERABLE_ERROR);</div>
<div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;                            }</div>
<div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160;                            rs2.next();</div>
<div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160;                        }</div>
<div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;                }</div>
<div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;            } <span class="keywordflow">catch</span> (SQLException e) {</div>
<div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160;                e.printStackTrace();</div>
<div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160;                System.exit(-3);</div>
<div class="line"><a name="l01213"></a><span class="lineno"> 1213</span>&#160;            } <span class="keywordflow">catch</span> (UnknownHostException e) {</div>
<div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;                e.printStackTrace();</div>
<div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160;                System.exit(-4);</div>
<div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160;            } <span class="keywordflow">catch</span> (Exception e) {</div>
<div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160;                e.printStackTrace();</div>
<div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;                System.exit(-5);</div>
<div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160;            }</div>
<div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;        }</div>
<div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;    }</div>
<div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;</div>
<div class="line"><a name="l01226"></a><span class="lineno"><a class="line" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#a69cf69b0f944a33ba7e1b9c32dd60ee6"> 1226</a></span>&#160;    <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#a69cf69b0f944a33ba7e1b9c32dd60ee6">start</a>() {</div>
<div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;        startPinger();</div>
<div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;        startDBStatusThread();</div>
<div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;        keepGoing = <span class="keyword">true</span>;</div>
<div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;        <span class="comment">/* create socket server and wait for connection requests */</span></div>
<div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;        <span class="keywordflow">try</span> {</div>
<div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160;            <span class="comment">// the socket used by the server</span></div>
<div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;            ServerSocket serverSocket = <span class="keyword">new</span> ServerSocket(port);</div>
<div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160;</div>
<div class="line"><a name="l01235"></a><span class="lineno"> 1235</span>&#160;            <span class="comment">// infinite loop to wait for connections</span></div>
<div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;            <span class="keywordflow">while</span> (keepGoing) {</div>
<div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;                <span class="comment">// format message saying we are waiting</span></div>
<div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160;                logger.fine(<span class="stringliteral">&quot;Waiting for Clients on port &quot;</span> + port + <span class="stringliteral">&quot;.&quot;</span>);</div>
<div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160;                <span class="comment">// ClientThread aNewClientThread = null;</span></div>
<div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;                <span class="keywordflow">try</span> {</div>
<div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160;                    Socket socket = serverSocket.accept(); <span class="comment">// accept connection if I was asked to stop</span></div>
<div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;</div>
<div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160;                    <span class="keyword">final</span> ClientThread aNewClientThread = <span class="keyword">new</span> ClientThread(socket); <span class="comment">// make the thread object for this potential</span></div>
<div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;                                                                                     <span class="comment">// client</span></div>
<div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;</div>
<div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160;                    <span class="keyword">new</span> Thread(<span class="stringliteral">&quot;InitializeClientThread&quot;</span>) {</div>
<div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160;                        <span class="keyword">public</span> <span class="keywordtype">void</span> run() {</div>
<div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160;</div>
<div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;                            <span class="comment">// Finish the initialization for this potential client</span></div>
<div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160;                            aNewClientThread.initialize();</div>
<div class="line"><a name="l01251"></a><span class="lineno"> 1251</span>&#160;</div>
<div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;                            <span class="keywordflow">if</span> (aNewClientThread.username != null) {</div>
<div class="line"><a name="l01253"></a><span class="lineno"> 1253</span>&#160;                                <span class="keywordflow">if</span> (listOfMessagingClients.add(aNewClientThread)) { <span class="comment">// save it in the ArrayList</span></div>
<div class="line"><a name="l01254"></a><span class="lineno"> 1254</span>&#160;                                    <span class="keywordflow">try</span> {</div>
<div class="line"><a name="l01255"></a><span class="lineno"> 1255</span>&#160;                                        String subject = aNewClientThread.username.substring(0,</div>
<div class="line"><a name="l01256"></a><span class="lineno"> 1256</span>&#160;                                                aNewClientThread.username.length() - (<span class="stringliteral">&quot;_&quot;</span> + aNewClientThread.id).length());</div>
<div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;                                        ClientThreadList ctl = subjectListeners.get(subject);</div>
<div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160;                                        <span class="keywordflow">if</span> (ctl == null) {</div>
<div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160;                                            ctl = <span class="keyword">new</span> ClientThreadList();</div>
<div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160;                                            subjectListeners.put(subject, ctl);</div>
<div class="line"><a name="l01261"></a><span class="lineno"> 1261</span>&#160;                                        }</div>
<div class="line"><a name="l01262"></a><span class="lineno"> 1262</span>&#160;                                        ctl.add(aNewClientThread);</div>
<div class="line"><a name="l01263"></a><span class="lineno"> 1263</span>&#160;                                        numConnectionsSeen--; <span class="comment">// Duplication of this parameter within the class ClientThreadList.</span></div>
<div class="line"><a name="l01264"></a><span class="lineno"> 1264</span>&#160;                                                                 <span class="comment">// oops</span></div>
<div class="line"><a name="l01265"></a><span class="lineno"> 1265</span>&#160;</div>
<div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160;                                        <span class="comment">// START THE THREAD to listen to this client</span></div>
<div class="line"><a name="l01267"></a><span class="lineno"> 1267</span>&#160;                                        aNewClientThread.start();</div>
<div class="line"><a name="l01268"></a><span class="lineno"> 1268</span>&#160;</div>
<div class="line"><a name="l01269"></a><span class="lineno"> 1269</span>&#160;                                    } <span class="keywordflow">catch</span> (Exception e) {</div>
<div class="line"><a name="l01270"></a><span class="lineno"> 1270</span>&#160;                                        logger.warning(getClass().getSimpleName() + <span class="stringliteral">&quot;\n&quot;</span> + <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#afe655a915ee116333ee6f1c8331b7929">exceptionString</a>(e) + <span class="stringliteral">&quot;\n&quot;</span></div>
<div class="line"><a name="l01271"></a><span class="lineno"> 1271</span>&#160;                                                + <span class="stringliteral">&quot; - Unexpected exception in messaging server \n\nTHIS SHOULD BE INVESTIGATED AND FIXED.\n\n&quot;</span>);</div>
<div class="line"><a name="l01272"></a><span class="lineno"> 1272</span>&#160;                                    }</div>
<div class="line"><a name="l01273"></a><span class="lineno"> 1273</span>&#160;                                } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l01274"></a><span class="lineno"> 1274</span>&#160;</div>
<div class="line"><a name="l01275"></a><span class="lineno"> 1275</span>&#160;                                    <span class="comment">// This code is never reached since the add() basically never fails (10/21/15)</span></div>
<div class="line"><a name="l01276"></a><span class="lineno"> 1276</span>&#160;</div>
<div class="line"><a name="l01277"></a><span class="lineno"> 1277</span>&#160;                                    logger.fine(<span class="stringliteral">&quot;Error! Duplicate username requested, &#39;&quot;</span> + aNewClientThread.username + <span class="stringliteral">&quot;&#39;&quot;</span>);</div>
<div class="line"><a name="l01278"></a><span class="lineno"> 1278</span>&#160;                                    <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#a90da887bb782b08af3fb1dbce8c3e502">showAllClientsConnectedNow</a>();</div>
<div class="line"><a name="l01279"></a><span class="lineno"> 1279</span>&#160;                                    aNewClientThread.start();</div>
<div class="line"><a name="l01280"></a><span class="lineno"> 1280</span>&#160;                                    aNewClientThread.writeUnsignedMsg(MessageCarrierXML.getErrorMessage(</div>
<div class="line"><a name="l01281"></a><span class="lineno"> 1281</span>&#160;                                            <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#a738da0a18944421491268d2220a3c7a4">SPECIAL_SERVER_MESSAGE_USERNAME</a>, aNewClientThread.username, <span class="stringliteral">&quot;A client with the name &quot;</span></div>
<div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;                                                    + aNewClientThread.username + <span class="stringliteral">&quot; has already connected.  Disconnecting now.&quot;</span>));</div>
<div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160;                                    numDuplicateClients++;</div>
<div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160;                                    aNewClientThread.close();</div>
<div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160;</div>
<div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;                                    <span class="comment">// We should probably remove BOTH clients from the permanent list. There are two cases seen so</span></div>
<div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;                                    <span class="comment">// far where this happens:</span></div>
<div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160;</div>
<div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;                                    <span class="comment">// 1. The user tries to start a second ChannelSelector from the same place;</span></div>
<div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;</div>
<div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160;                                    <span class="comment">// 2. Something I don&#39;t understand happens to a client and (a) we don&#39;t drop it here and (b) it</span></div>
<div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;                                    <span class="comment">// tries to reconnect. In both cases, the real client will eventually try to reconnect.</span></div>
<div class="line"><a name="l01293"></a><span class="lineno"> 1293</span>&#160;</div>
<div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;                                    <span class="keywordtype">int</span> index = 0;</div>
<div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;                                    <span class="keywordflow">for</span> (ClientThread CT : listOfMessagingClients) {</div>
<div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;                                        <span class="keywordflow">if</span> (CT == null || CT.username == null) {</div>
<div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;                                            logger.fine(</div>
<div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160;                                                    <span class="stringliteral">&quot;start(): Unexpected null ClientThread at index=&quot;</span> + index + <span class="stringliteral">&quot;: [&quot;</span> + CT + <span class="stringliteral">&quot;]&quot;</span>);</div>
<div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160;                                            <span class="keyword">remove</span>(CT); <span class="comment">// How did THIS happen??</span></div>
<div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160;                                            <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#a84d7bc143f1eee20c7e39ce9024783c9">numRemovedNullUsername</a>++;</div>
<div class="line"><a name="l01301"></a><span class="lineno"> 1301</span>&#160;                                        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (CT.username.equals(aNewClientThread.username)) {</div>
<div class="line"><a name="l01302"></a><span class="lineno"> 1302</span>&#160;                                            logger.fine(</div>
<div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160;                                                    <span class="stringliteral">&quot;start(): Removing duplicate client &quot;</span> + CT.username + <span class="stringliteral">&quot; from the client list&quot;</span>);</div>
<div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160;                                            <span class="keyword">remove</span>(CT); <span class="comment">// Duplicate username is not allowed!</span></div>
<div class="line"><a name="l01305"></a><span class="lineno"> 1305</span>&#160;                                            numRemovedDuplicateUsername++;</div>
<div class="line"><a name="l01306"></a><span class="lineno"> 1306</span>&#160;                                        }</div>
<div class="line"><a name="l01307"></a><span class="lineno"> 1307</span>&#160;                                        index++;</div>
<div class="line"><a name="l01308"></a><span class="lineno"> 1308</span>&#160;                                    }</div>
<div class="line"><a name="l01309"></a><span class="lineno"> 1309</span>&#160;</div>
<div class="line"><a name="l01310"></a><span class="lineno"> 1310</span>&#160;                                    <span class="comment">// continue; No, I think (now) that fall through is appropriate.</span></div>
<div class="line"><a name="l01311"></a><span class="lineno"> 1311</span>&#160;                                }</div>
<div class="line"><a name="l01312"></a><span class="lineno"> 1312</span>&#160;                            } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160;                                numPortScannerAttempts++;</div>
<div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160;                                logger.warning(getClass().getSimpleName()</div>
<div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160;                                        + <span class="stringliteral">&quot; - A client attempted to connect, but the username it presented is null.&quot;</span></div>
<div class="line"><a name="l01316"></a><span class="lineno"> 1316</span>&#160;                                        + <span class="stringliteral">&quot;\n\t\tThis usually means that a port scanner has tried to connect.&quot;</span>);</div>
<div class="line"><a name="l01317"></a><span class="lineno"> 1317</span>&#160;                                <span class="comment">// This null check is not necessary since this is the else clause of if(t.username!=null).</span></div>
<div class="line"><a name="l01318"></a><span class="lineno"> 1318</span>&#160;                                <span class="comment">// But it makes me feel better.</span></div>
<div class="line"><a name="l01319"></a><span class="lineno"> 1319</span>&#160;                                <span class="keywordflow">if</span> (aNewClientThread != null)</div>
<div class="line"><a name="l01320"></a><span class="lineno"> 1320</span>&#160;                                    aNewClientThread.close(); <span class="comment">// Close it</span></div>
<div class="line"><a name="l01321"></a><span class="lineno"> 1321</span>&#160;                                <span class="comment">// aNewClientThread = null; // Forget it</span></div>
<div class="line"><a name="l01322"></a><span class="lineno"> 1322</span>&#160;                                <span class="comment">// continue;</span></div>
<div class="line"><a name="l01323"></a><span class="lineno"> 1323</span>&#160;                            }</div>
<div class="line"><a name="l01324"></a><span class="lineno"> 1324</span>&#160;</div>
<div class="line"><a name="l01325"></a><span class="lineno"> 1325</span>&#160;                            <span class="comment">// When this thread exits, either the ClientThread object is for a valid client and it stored, or it is</span></div>
<div class="line"><a name="l01326"></a><span class="lineno"> 1326</span>&#160;                            <span class="comment">// forgotten and garbage collected.</span></div>
<div class="line"><a name="l01327"></a><span class="lineno"> 1327</span>&#160;</div>
<div class="line"><a name="l01328"></a><span class="lineno"> 1328</span>&#160;                        }</div>
<div class="line"><a name="l01329"></a><span class="lineno"> 1329</span>&#160;                    }.start();</div>
<div class="line"><a name="l01330"></a><span class="lineno"> 1330</span>&#160;                } <span class="keywordflow">catch</span> (Exception e) {</div>
<div class="line"><a name="l01331"></a><span class="lineno"> 1331</span>&#160;                    logger.warning(getClass().getSimpleName() + <span class="stringliteral">&quot; - Unexpected exception when listening to port &quot;</span> + port</div>
<div class="line"><a name="l01332"></a><span class="lineno"> 1332</span>&#160;                            + <span class="stringliteral">&quot;.  Let&#39;s try again.\n&quot;</span> + <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#afe655a915ee116333ee6f1c8331b7929">exceptionString</a>(e));</div>
<div class="line"><a name="l01333"></a><span class="lineno"> 1333</span>&#160;                    <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l01334"></a><span class="lineno"> 1334</span>&#160;                }</div>
<div class="line"><a name="l01335"></a><span class="lineno"> 1335</span>&#160;</div>
<div class="line"><a name="l01336"></a><span class="lineno"> 1336</span>&#160;                <span class="keywordflow">if</span> (showClientList == null) {</div>
<div class="line"><a name="l01337"></a><span class="lineno"> 1337</span>&#160;</div>
<div class="line"><a name="l01338"></a><span class="lineno"> 1338</span>&#160;                    <span class="comment">// This block is to print out the current set of clients. Rather than printing it out every time</span></div>
<div class="line"><a name="l01339"></a><span class="lineno"> 1339</span>&#160;                    <span class="comment">// a client connects, we wait 3 seconds from the first connect to do this. Usually, a lot of clients</span></div>
<div class="line"><a name="l01340"></a><span class="lineno"> 1340</span>&#160;                    <span class="comment">// connect at the same time--either the Channel Selector or when all the Displays reboot.</span></div>
<div class="line"><a name="l01341"></a><span class="lineno"> 1341</span>&#160;</div>
<div class="line"><a name="l01342"></a><span class="lineno"> 1342</span>&#160;                    showClientList = <span class="keyword">new</span> Thread(<span class="stringliteral">&quot;ShowClientList&quot;</span>) {</div>
<div class="line"><a name="l01343"></a><span class="lineno"> 1343</span>&#160;                        <span class="keywordtype">long</span> WAIT_FOR_ALL_TO_CONNECT_TIME = 4000L;</div>
<div class="line"><a name="l01344"></a><span class="lineno"> 1344</span>&#160;</div>
<div class="line"><a name="l01345"></a><span class="lineno"> 1345</span>&#160;                        <span class="keyword">public</span> <span class="keywordtype">void</span> run() {</div>
<div class="line"><a name="l01346"></a><span class="lineno"> 1346</span>&#160;                            <span class="keywordflow">try</span> {</div>
<div class="line"><a name="l01347"></a><span class="lineno"> 1347</span>&#160;                                catchSleep(WAIT_FOR_ALL_TO_CONNECT_TIME);</div>
<div class="line"><a name="l01348"></a><span class="lineno"> 1348</span>&#160;                                <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#a90da887bb782b08af3fb1dbce8c3e502">showAllClientsConnectedNow</a>();</div>
<div class="line"><a name="l01349"></a><span class="lineno"> 1349</span>&#160;                                <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#af24f72f6ce9d270c33afb4032d9c968b">performDiagnostics</a>(<span class="keyword">true</span>);</div>
<div class="line"><a name="l01350"></a><span class="lineno"> 1350</span>&#160;                            } <span class="keywordflow">catch</span> (Exception e) {</div>
<div class="line"><a name="l01351"></a><span class="lineno"> 1351</span>&#160;                                logger.warning(<a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#afe655a915ee116333ee6f1c8331b7929">exceptionString</a>(e));</div>
<div class="line"><a name="l01352"></a><span class="lineno"> 1352</span>&#160;                            }</div>
<div class="line"><a name="l01353"></a><span class="lineno"> 1353</span>&#160;                            showClientList = null;</div>
<div class="line"><a name="l01354"></a><span class="lineno"> 1354</span>&#160;                        }</div>
<div class="line"><a name="l01355"></a><span class="lineno"> 1355</span>&#160;                    };</div>
<div class="line"><a name="l01356"></a><span class="lineno"> 1356</span>&#160;                    showClientList.start();</div>
<div class="line"><a name="l01357"></a><span class="lineno"> 1357</span>&#160;                    <span class="comment">// } else { not really necessary to show this print statement every time!</span></div>
<div class="line"><a name="l01358"></a><span class="lineno"> 1358</span>&#160;                    <span class="comment">// logger.fine(&quot;Already waiting to show the client list&quot;);</span></div>
<div class="line"><a name="l01359"></a><span class="lineno"> 1359</span>&#160;                }</div>
<div class="line"><a name="l01360"></a><span class="lineno"> 1360</span>&#160;            }</div>
<div class="line"><a name="l01361"></a><span class="lineno"> 1361</span>&#160;            <span class="comment">// I was asked to stop</span></div>
<div class="line"><a name="l01362"></a><span class="lineno"> 1362</span>&#160;            logger.fine(<span class="stringliteral">&quot;Closing the server port&quot;</span>);</div>
<div class="line"><a name="l01363"></a><span class="lineno"> 1363</span>&#160;            <span class="keywordflow">try</span> {</div>
<div class="line"><a name="l01364"></a><span class="lineno"> 1364</span>&#160;                <span class="comment">// if (serverSocket != null) Compiler says it cannot be null here</span></div>
<div class="line"><a name="l01365"></a><span class="lineno"> 1365</span>&#160;                serverSocket.close();</div>
<div class="line"><a name="l01366"></a><span class="lineno"> 1366</span>&#160;                <span class="keywordflow">for</span> (ClientThread tc : listOfMessagingClients) {</div>
<div class="line"><a name="l01367"></a><span class="lineno"> 1367</span>&#160;                    <span class="keywordflow">try</span> {</div>
<div class="line"><a name="l01368"></a><span class="lineno"> 1368</span>&#160;                        <span class="keywordflow">if</span> (tc != null) {</div>
<div class="line"><a name="l01369"></a><span class="lineno"> 1369</span>&#160;                            <span class="keywordflow">if</span> (tc.sInput != null)</div>
<div class="line"><a name="l01370"></a><span class="lineno"> 1370</span>&#160;                                tc.sInput.close();</div>
<div class="line"><a name="l01371"></a><span class="lineno"> 1371</span>&#160;                            <span class="keywordflow">if</span> (tc.sOutput != null)</div>
<div class="line"><a name="l01372"></a><span class="lineno"> 1372</span>&#160;                                tc.sOutput.close();</div>
<div class="line"><a name="l01373"></a><span class="lineno"> 1373</span>&#160;                            <span class="keywordflow">if</span> (tc.socket != null)</div>
<div class="line"><a name="l01374"></a><span class="lineno"> 1374</span>&#160;                                tc.socket.close();</div>
<div class="line"><a name="l01375"></a><span class="lineno"> 1375</span>&#160;                        }</div>
<div class="line"><a name="l01376"></a><span class="lineno"> 1376</span>&#160;                    } <span class="keywordflow">catch</span> (Exception ee) {</div>
<div class="line"><a name="l01377"></a><span class="lineno"> 1377</span>&#160;                        <span class="comment">// not much I can do</span></div>
<div class="line"><a name="l01378"></a><span class="lineno"> 1378</span>&#160;                        logger.warning(<a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#afe655a915ee116333ee6f1c8331b7929">exceptionString</a>(ee));</div>
<div class="line"><a name="l01379"></a><span class="lineno"> 1379</span>&#160;                    }</div>
<div class="line"><a name="l01380"></a><span class="lineno"> 1380</span>&#160;                }</div>
<div class="line"><a name="l01381"></a><span class="lineno"> 1381</span>&#160;            } <span class="keywordflow">catch</span> (Exception e) {</div>
<div class="line"><a name="l01382"></a><span class="lineno"> 1382</span>&#160;                logger.warning(<span class="stringliteral">&quot;Exception closing the server and clients: &quot;</span> + e + <span class="stringliteral">&quot;\n&quot;</span> + <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#afe655a915ee116333ee6f1c8331b7929">exceptionString</a>(e));</div>
<div class="line"><a name="l01383"></a><span class="lineno"> 1383</span>&#160;            }</div>
<div class="line"><a name="l01384"></a><span class="lineno"> 1384</span>&#160;        }</div>
<div class="line"><a name="l01385"></a><span class="lineno"> 1385</span>&#160;        <span class="comment">// something went wrong</span></div>
<div class="line"><a name="l01386"></a><span class="lineno"> 1386</span>&#160;        <span class="keywordflow">catch</span> (IOException e) {</div>
<div class="line"><a name="l01387"></a><span class="lineno"> 1387</span>&#160;            logger.warning(<span class="stringliteral">&quot;IOException on new ServerSocket: &quot;</span> + e + <span class="stringliteral">&quot;\n&quot;</span> + <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#afe655a915ee116333ee6f1c8331b7929">exceptionString</a>(e));</div>
<div class="line"><a name="l01388"></a><span class="lineno"> 1388</span>&#160;        } <span class="keywordflow">catch</span> (Exception e) {</div>
<div class="line"><a name="l01389"></a><span class="lineno"> 1389</span>&#160;            logger.warning(<span class="stringliteral">&quot;Exception on new ServerSocket: &quot;</span> + e + <span class="stringliteral">&quot;\n&quot;</span> + <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#afe655a915ee116333ee6f1c8331b7929">exceptionString</a>(e));</div>
<div class="line"><a name="l01390"></a><span class="lineno"> 1390</span>&#160;        }</div>
<div class="line"><a name="l01391"></a><span class="lineno"> 1391</span>&#160;        logger.warning(getClass().getSimpleName() + <span class="stringliteral">&quot; - Exiting SERVER thread for listening to the messaging socket on port &quot;</span> + port</div>
<div class="line"><a name="l01392"></a><span class="lineno"> 1392</span>&#160;                + <span class="stringliteral">&quot;.  THIS SHOULD ONLY HAPPEN when the program exits.&quot;</span>);</div>
<div class="line"><a name="l01393"></a><span class="lineno"> 1393</span>&#160;    }</div>
<div class="line"><a name="l01394"></a><span class="lineno"> 1394</span>&#160;</div>
<div class="line"><a name="l01395"></a><span class="lineno"> 1395</span>&#160;    <span class="keyword">private</span> <span class="keywordtype">void</span> startDBStatusThread() {</div>
<div class="line"><a name="l01396"></a><span class="lineno"> 1396</span>&#160;        <span class="keyword">new</span> Thread(<span class="stringliteral">&quot;DBStatusUpdate&quot;</span>) {</div>
<div class="line"><a name="l01397"></a><span class="lineno"> 1397</span>&#160;            <span class="keyword">public</span> <span class="keywordtype">void</span> run() {</div>
<div class="line"><a name="l01398"></a><span class="lineno"> 1398</span>&#160;                <span class="keywordflow">while</span> (<span class="keyword">true</span>) {</div>
<div class="line"><a name="l01399"></a><span class="lineno"> 1399</span>&#160;                    catchSleep(15 * ONE_SECOND);</div>
<div class="line"><a name="l01400"></a><span class="lineno"> 1400</span>&#160;                    <span class="keywordflow">try</span> {</div>
<div class="line"><a name="l01401"></a><span class="lineno"> 1401</span>&#160;                        String m = <span class="stringliteral">&quot;&quot;</span>;</div>
<div class="line"><a name="l01402"></a><span class="lineno"> 1402</span>&#160;                        <span class="keywordflow">if</span> (listOfMessagingClients.size() == 0) {</div>
<div class="line"><a name="l01403"></a><span class="lineno"> 1403</span>&#160;                            m = <span class="stringliteral">&quot;No clients are connected.\n&quot;</span>;</div>
<div class="line"><a name="l01404"></a><span class="lineno"> 1404</span>&#160;                        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l01405"></a><span class="lineno"> 1405</span>&#160;                            m = listOfMessagingClients.size() + <span class="stringliteral">&quot; clients:\n&quot;</span>;</div>
<div class="line"><a name="l01406"></a><span class="lineno"> 1406</span>&#160;                            String un = <span class="stringliteral">&quot;Name=&quot;</span>;</div>
<div class="line"><a name="l01407"></a><span class="lineno"> 1407</span>&#160;                            String ip = <span class="stringliteral">&quot;Address=&quot;</span>;</div>
<div class="line"><a name="l01408"></a><span class="lineno"> 1408</span>&#160;                            String idn = <span class="stringliteral">&quot;Local ID=&quot;</span>;</div>
<div class="line"><a name="l01409"></a><span class="lineno"> 1409</span>&#160;                            <span class="keywordflow">for</span> (ClientThread CT : listOfMessagingClients) {</div>
<div class="line"><a name="l01410"></a><span class="lineno"> 1410</span>&#160;                                m += <span class="stringliteral">&quot;[&quot;</span> + un + CT.username.replace(<span class="stringliteral">&quot;.&quot;</span> + TOP_LEVEL_DOMAIN, <span class="stringliteral">&quot;&quot;</span>) + <span class="stringliteral">&quot;|&quot;</span> + ip + CT.getRemoteIPAddress()</div>
<div class="line"><a name="l01411"></a><span class="lineno"> 1411</span>&#160;                                        + <span class="stringliteral">&quot;|&quot;</span> + idn + CT.id + <span class="stringliteral">&quot;]\n&quot;</span>;</div>
<div class="line"><a name="l01412"></a><span class="lineno"> 1412</span>&#160;                                un = ip = idn = <span class="stringliteral">&quot;&quot;</span>;</div>
<div class="line"><a name="l01413"></a><span class="lineno"> 1413</span>&#160;                            }</div>
<div class="line"><a name="l01414"></a><span class="lineno"> 1414</span>&#160;                        }</div>
<div class="line"><a name="l01415"></a><span class="lineno"> 1415</span>&#160;                        String stats = <span class="stringliteral">&quot;\nNum Subjects: &quot;</span> + subjectListeners.size() + <span class="stringliteral">&quot;.\nOther stats: &quot;</span></div>
<div class="line"><a name="l01416"></a><span class="lineno"> 1416</span>&#160;                                + <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#a189ff6081d21eb1a9c98887d84e23b17">numRemovedExitedForeverLoop</a> + <span class="stringliteral">&quot;, &quot;</span> + numRemovedForPings1 + <span class="stringliteral">&quot;, &quot;</span> + numberOfServerMessagesReceived</div>
<div class="line"><a name="l01417"></a><span class="lineno"> 1417</span>&#160;                                + <span class="stringliteral">&quot;, &quot;</span> + numUnexpectedClosedSockets1 + <span class="stringliteral">&quot;, &quot;</span> + numUnexpectedClosedSockets2 + <span class="stringliteral">&quot;, &quot;</span></div>
<div class="line"><a name="l01418"></a><span class="lineno"> 1418</span>&#160;                                + numDuplicateClients + <span class="stringliteral">&quot; (&quot;</span> + numClosedCallsSeen + <span class="stringliteral">&quot;), &quot;</span> + numClientsPutOnNotice + <span class="stringliteral">&quot;, &quot;</span></div>
<div class="line"><a name="l01419"></a><span class="lineno"> 1419</span>&#160;                                + <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#ae9c73322e842357c87634a60426e5bf0">numRemovedBadWriteSeen</a> + <span class="stringliteral">&quot;, &quot;</span> + <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#a3fe04e43605b1c81c063cf9d334fb763">numRemovedNullClientThread</a> + <span class="stringliteral">&quot;, &quot;</span> + <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#a84d7bc143f1eee20c7e39ce9024783c9">numRemovedNullUsername</a> + <span class="stringliteral">&quot;, &quot;</span></div>
<div class="line"><a name="l01420"></a><span class="lineno"> 1420</span>&#160;                                + <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#ab986fa29bcdc51bd186ad23e1c699426">numRemovedNullDate</a> + <span class="stringliteral">&quot;, &quot;</span> + numRemovedDuplicateUsername + <span class="stringliteral">&quot;, &quot;</span> + numLogoutsSeen + <span class="stringliteral">&quot;, &quot;</span></div>
<div class="line"><a name="l01421"></a><span class="lineno"> 1421</span>&#160;                                + numPortScannerAttempts;</div>
<div class="line"><a name="l01422"></a><span class="lineno"> 1422</span>&#160;</div>
<div class="line"><a name="l01423"></a><span class="lineno"> 1423</span>&#160;                        <span class="keywordflow">if</span> (m.length() + stats.length() &gt; MAX_STATUS_MESSAGE_SIZE) {</div>
<div class="line"><a name="l01424"></a><span class="lineno"> 1424</span>&#160;                            String extra = <span class="stringliteral">&quot; (exceeds &quot;</span> + MAX_STATUS_MESSAGE_SIZE + <span class="stringliteral">&quot; bytes)&quot;</span>;</div>
<div class="line"><a name="l01425"></a><span class="lineno"> 1425</span>&#160;                            m = m.substring(0, MAX_STATUS_MESSAGE_SIZE - stats.length() - extra.length() - 2) + extra;</div>
<div class="line"><a name="l01426"></a><span class="lineno"> 1426</span>&#160;                        }</div>
<div class="line"><a name="l01427"></a><span class="lineno"> 1427</span>&#160;                        updateStatus(m + stats);</div>
<div class="line"><a name="l01428"></a><span class="lineno"> 1428</span>&#160;                    } <span class="keywordflow">catch</span> (Exception e) {</div>
<div class="line"><a name="l01429"></a><span class="lineno"> 1429</span>&#160;                        logger.warning(<span class="stringliteral">&quot;Exception in DB status update thread: &quot;</span> + e + <span class="stringliteral">&quot;\n&quot;</span> + <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#afe655a915ee116333ee6f1c8331b7929">exceptionString</a>(e));</div>
<div class="line"><a name="l01430"></a><span class="lineno"> 1430</span>&#160;                    }</div>
<div class="line"><a name="l01431"></a><span class="lineno"> 1431</span>&#160;                } <span class="comment">// end of forever loop.</span></div>
<div class="line"><a name="l01432"></a><span class="lineno"> 1432</span>&#160;            }</div>
<div class="line"><a name="l01433"></a><span class="lineno"> 1433</span>&#160;        }.start();</div>
<div class="line"><a name="l01434"></a><span class="lineno"> 1434</span>&#160;</div>
<div class="line"><a name="l01435"></a><span class="lineno"> 1435</span>&#160;        Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> Thread() {</div>
<div class="line"><a name="l01436"></a><span class="lineno"> 1436</span>&#160;            @Override</div>
<div class="line"><a name="l01437"></a><span class="lineno"> 1437</span>&#160;            <span class="keyword">public</span> <span class="keywordtype">void</span> run() {</div>
<div class="line"><a name="l01438"></a><span class="lineno"> 1438</span>&#160;                <span class="keywordflow">try</span> {</div>
<div class="line"><a name="l01439"></a><span class="lineno"> 1439</span>&#160;                    updateStatus(<span class="stringliteral">&quot;** OFF LINE **&quot;</span>);</div>
<div class="line"><a name="l01440"></a><span class="lineno"> 1440</span>&#160;                } <span class="keywordflow">catch</span> (Exception e) {</div>
<div class="line"><a name="l01441"></a><span class="lineno"> 1441</span>&#160;                    e.printStackTrace();</div>
<div class="line"><a name="l01442"></a><span class="lineno"> 1442</span>&#160;                }</div>
<div class="line"><a name="l01443"></a><span class="lineno"> 1443</span>&#160;            }</div>
<div class="line"><a name="l01444"></a><span class="lineno"> 1444</span>&#160;</div>
<div class="line"><a name="l01445"></a><span class="lineno"> 1445</span>&#160;        });</div>
<div class="line"><a name="l01446"></a><span class="lineno"> 1446</span>&#160;    }</div>
<div class="line"><a name="l01447"></a><span class="lineno"> 1447</span>&#160;</div>
<div class="line"><a name="l01448"></a><span class="lineno"><a class="line" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#a90da887bb782b08af3fb1dbce8c3e502"> 1448</a></span>&#160;    <span class="keyword">protected</span> <span class="keywordtype">void</span> <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#a90da887bb782b08af3fb1dbce8c3e502">showAllClientsConnectedNow</a>() {</div>
<div class="line"><a name="l01449"></a><span class="lineno"> 1449</span>&#160;        String m = <span class="stringliteral">&quot;List of connected clients:\n&quot;</span>;</div>
<div class="line"><a name="l01450"></a><span class="lineno"> 1450</span>&#160;        <span class="keywordflow">for</span> (ClientThread CT : listOfMessagingClients) {</div>
<div class="line"><a name="l01451"></a><span class="lineno"> 1451</span>&#160;            String p = CT.username + <span class="stringliteral">&quot; (&quot;</span> + CT.getRemoteIPAddress() + <span class="stringliteral">&quot;)&quot;</span>;</div>
<div class="line"><a name="l01452"></a><span class="lineno"> 1452</span>&#160;            <span class="keywordflow">if</span> (p.length() &lt; 40)</div>
<div class="line"><a name="l01453"></a><span class="lineno"> 1453</span>&#160;                p += <span class="stringliteral">&quot;\t&quot;</span>;</div>
<div class="line"><a name="l01454"></a><span class="lineno"> 1454</span>&#160;            m += <span class="stringliteral">&quot;\t&quot;</span> + p + <span class="stringliteral">&quot;\tLast seen &quot;</span> + sdf.format(<span class="keyword">new</span> Date(CT.getLastSeen())) + <span class="stringliteral">&quot; ID=&quot;</span> + CT.id + <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line"><a name="l01455"></a><span class="lineno"> 1455</span>&#160;        }</div>
<div class="line"><a name="l01456"></a><span class="lineno"> 1456</span>&#160;        logger.fine(m);</div>
<div class="line"><a name="l01457"></a><span class="lineno"> 1457</span>&#160;    }</div>
<div class="line"><a name="l01458"></a><span class="lineno"> 1458</span>&#160;</div>
<div class="line"><a name="l01459"></a><span class="lineno"> 1459</span>&#160;    <span class="keyword">private</span> ClientThread lastOldestClientName = null;</div>
<div class="line"><a name="l01460"></a><span class="lineno"> 1460</span>&#160;</div>
<div class="line"><a name="l01464"></a><span class="lineno"> 1464</span>&#160;    <span class="keyword">private</span> <span class="keywordtype">void</span> startPinger() {</div>
<div class="line"><a name="l01465"></a><span class="lineno"> 1465</span>&#160;        <span class="keyword">new</span> Thread(<span class="stringliteral">&quot;Pinger&quot;</span>) {</div>
<div class="line"><a name="l01466"></a><span class="lineno"> 1466</span>&#160;            <span class="keyword">private</span> <span class="keywordtype">int</span>     nextClient          = 0;</div>
<div class="line"><a name="l01467"></a><span class="lineno"> 1467</span>&#160;            <span class="keyword">private</span> <span class="keywordtype">long</span>    lastPrint           = System.currentTimeMillis();</div>
<div class="line"><a name="l01468"></a><span class="lineno"> 1468</span>&#160;            <span class="comment">/*</span></div>
<div class="line"><a name="l01469"></a><span class="lineno"> 1469</span>&#160;<span class="comment">             * Experience says that nodes do not drop off the network very often. They seemed to drop off a lot in the early days,</span></div>
<div class="line"><a name="l01470"></a><span class="lineno"> 1470</span>&#160;<span class="comment">             * but not now. Each diagnostic dump is about 2.5k. 2 minutes is plenty fast enough, but produces about 47 dumps of who</span></div>
<div class="line"><a name="l01471"></a><span class="lineno"> 1471</span>&#160;<span class="comment">             * is alive every hour. This implies that upwards of 2.7MB per day is logged because of these dumps. Setting this</span></div>
<div class="line"><a name="l01472"></a><span class="lineno"> 1472</span>&#160;<span class="comment">             * parameter slower means that when a node drops off the network, it will take about half of that wait time for the</span></div>
<div class="line"><a name="l01473"></a><span class="lineno"> 1473</span>&#160;<span class="comment">             * server to forget it - then the node will try again.</span></div>
<div class="line"><a name="l01474"></a><span class="lineno"> 1474</span>&#160;<span class="comment">             */</span></div>
<div class="line"><a name="l01475"></a><span class="lineno"> 1475</span>&#160;            <span class="keyword">private</span> <span class="keywordtype">long</span>    diagnosticPeriod    = 3 * ONE_MINUTE;</div>
<div class="line"><a name="l01476"></a><span class="lineno"> 1476</span>&#160;            <span class="keyword">private</span> <span class="keywordtype">long</span>    sleepPeriodBtwPings = 2 * ONE_SECOND;</div>
<div class="line"><a name="l01477"></a><span class="lineno"> 1477</span>&#160;</div>
<div class="line"><a name="l01478"></a><span class="lineno"> 1478</span>&#160;            <span class="keyword">public</span> <span class="keywordtype">void</span> run() {</div>
<div class="line"><a name="l01479"></a><span class="lineno"> 1479</span>&#160;                catchSleep(15000L); <span class="comment">// Wait a bit before starting the pinging and the diagnostics</span></div>
<div class="line"><a name="l01480"></a><span class="lineno"> 1480</span>&#160;                <span class="keywordtype">int</span> counter = 0, randomCycleModulo = 2;</div>
<div class="line"><a name="l01481"></a><span class="lineno"> 1481</span>&#160;</div>
<div class="line"><a name="l01482"></a><span class="lineno"> 1482</span>&#160;                <span class="keywordflow">while</span> (keepGoing)</div>
<div class="line"><a name="l01483"></a><span class="lineno"> 1483</span>&#160;                    <span class="keywordflow">try</span> {</div>
<div class="line"><a name="l01484"></a><span class="lineno"> 1484</span>&#160;                        catchSleep(sleepPeriodBtwPings);</div>
<div class="line"><a name="l01485"></a><span class="lineno"> 1485</span>&#160;</div>
<div class="line"><a name="l01486"></a><span class="lineno"> 1486</span>&#160;                        <span class="keywordflow">if</span> (listOfMessagingClients.size() == 0)</div>
<div class="line"><a name="l01487"></a><span class="lineno"> 1487</span>&#160;                            <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l01488"></a><span class="lineno"> 1488</span>&#160;</div>
<div class="line"><a name="l01489"></a><span class="lineno"> 1489</span>&#160;                        <span class="comment">// This sleep period assures that each client is ping&#39;ed at least three times before it is &quot;too old&quot;</span></div>
<div class="line"><a name="l01490"></a><span class="lineno"> 1490</span>&#160;                        sleepPeriodBtwPings = Math.min(tooOldTime / listOfMessagingClients.size() / 3L, 10 * ONE_SECOND);</div>
<div class="line"><a name="l01491"></a><span class="lineno"> 1491</span>&#160;                        <span class="comment">// Note: For 50 clients and tooOld = 90 seconds:</span></div>
<div class="line"><a name="l01492"></a><span class="lineno"> 1492</span>&#160;                        <span class="comment">// The sleep is 600 msec., and every client is pinged at a period of 30 seconds</span></div>
<div class="line"><a name="l01493"></a><span class="lineno"> 1493</span>&#160;</div>
<div class="line"><a name="l01494"></a><span class="lineno"> 1494</span>&#160;                        <span class="keywordflow">if</span> (sleepPeriodBtwPings &lt; 100L) { <span class="comment">// Idiot check</span></div>
<div class="line"><a name="l01495"></a><span class="lineno"> 1495</span>&#160;                            logger.fine(<span class="stringliteral">&quot;CAUTION: The time between pings in &#39;startPinger()&#39; is rather short: &quot;</span> + sleepPeriodBtwPings</div>
<div class="line"><a name="l01496"></a><span class="lineno"> 1496</span>&#160;                                    + <span class="stringliteral">&quot; msec.  This is untested territory for the messaging server.&quot;</span>);</div>
<div class="line"><a name="l01497"></a><span class="lineno"> 1497</span>&#160;                            logger.fine(<span class="stringliteral">&quot;CAUTION: This will happen where there are more than &quot;</span> + (tooOldTime / 100L)</div>
<div class="line"><a name="l01498"></a><span class="lineno"> 1498</span>&#160;                                    + <span class="stringliteral">&quot; clients in the system; there are presently &quot;</span> + listOfMessagingClients.size()</div>
<div class="line"><a name="l01499"></a><span class="lineno"> 1499</span>&#160;                                    + <span class="stringliteral">&quot; clients in the system.&quot;</span>);</div>
<div class="line"><a name="l01500"></a><span class="lineno"> 1500</span>&#160;                            logger.fine(<span class="stringliteral">&quot;CAUTION: Setting the sleep time between ping cycles to 100 msec.&quot;</span>);</div>
<div class="line"><a name="l01501"></a><span class="lineno"> 1501</span>&#160;                            sleepPeriodBtwPings = 100L;</div>
<div class="line"><a name="l01502"></a><span class="lineno"> 1502</span>&#160;                        }</div>
<div class="line"><a name="l01503"></a><span class="lineno"> 1503</span>&#160;</div>
<div class="line"><a name="l01504"></a><span class="lineno"> 1504</span>&#160;                        <span class="comment">/*</span></div>
<div class="line"><a name="l01505"></a><span class="lineno"> 1505</span>&#160;<span class="comment">                         * This boolean turns on the diagnostic message (in ClientThread.run()) that echos when a client says</span></div>
<div class="line"><a name="l01506"></a><span class="lineno"> 1506</span>&#160;<span class="comment">                         * &quot;I am alive&quot;. Turn it on for two minutes, just before the diagnostic is printed, which would show about</span></div>
<div class="line"><a name="l01507"></a><span class="lineno"> 1507</span>&#160;<span class="comment">                         * 60 such messages (at a frequency of 0.5Hz). today, there are ~40 clients connected, so we&#39;ll see them all</span></div>
<div class="line"><a name="l01508"></a><span class="lineno"> 1508</span>&#160;<span class="comment">                         */</span></div>
<div class="line"><a name="l01509"></a><span class="lineno"> 1509</span>&#160;                        showAliveMessages = (lastPrint + 13 * ONE_MINUTE) &lt; System.currentTimeMillis();</div>
<div class="line"><a name="l01510"></a><span class="lineno"> 1510</span>&#160;</div>
<div class="line"><a name="l01511"></a><span class="lineno"> 1511</span>&#160;                        <span class="comment">// Figure out which client(s) to ping</span></div>
<div class="line"><a name="l01512"></a><span class="lineno"> 1512</span>&#160;                        List&lt;ClientThread&gt; clist = <span class="keyword">new</span> ArrayList&lt;ClientThread&gt;();</div>
<div class="line"><a name="l01513"></a><span class="lineno"> 1513</span>&#160;</div>
<div class="line"><a name="l01514"></a><span class="lineno"> 1514</span>&#160;                        <span class="keywordtype">long</span> oldestTime = System.currentTimeMillis();</div>
<div class="line"><a name="l01515"></a><span class="lineno"> 1515</span>&#160;                        ClientThread oldestClientName = null;</div>
<div class="line"><a name="l01516"></a><span class="lineno"> 1516</span>&#160;                        <span class="comment">// Ping any client that is &quot;on notice&quot;, plus the oldest one that is not on notice.</span></div>
<div class="line"><a name="l01517"></a><span class="lineno"> 1517</span>&#160;</div>
<div class="line"><a name="l01518"></a><span class="lineno"> 1518</span>&#160;                        <span class="comment">// This variable, printme, will be true once or twice per diagnostic period.</span></div>
<div class="line"><a name="l01519"></a><span class="lineno"> 1519</span>&#160;                        <span class="keywordtype">boolean</span> printMe = (++counter % (diagnosticPeriod / sleepPeriodBtwPings)) == randomCycleModulo;</div>
<div class="line"><a name="l01520"></a><span class="lineno"> 1520</span>&#160;                        String diagnostic = <span class="stringliteral">&quot;Diagnostic update\n---- Cycle no. &quot;</span> + counter + <span class="stringliteral">&quot; (%&quot;</span></div>
<div class="line"><a name="l01521"></a><span class="lineno"> 1521</span>&#160;                                + (diagnosticPeriod / sleepPeriodBtwPings) + <span class="stringliteral">&quot;=&quot;</span> + randomCycleModulo + <span class="stringliteral">&quot;)&quot;</span>;</div>
<div class="line"><a name="l01522"></a><span class="lineno"> 1522</span>&#160;</div>
<div class="line"><a name="l01523"></a><span class="lineno"> 1523</span>&#160;                        <span class="keywordtype">int</span> i = 0, theMostPings = 0;</div>
<div class="line"><a name="l01524"></a><span class="lineno"> 1524</span>&#160;                        <span class="keywordflow">for</span> (ClientThread CT : listOfMessagingClients) {</div>
<div class="line"><a name="l01525"></a><span class="lineno"> 1525</span>&#160;                            i++;</div>
<div class="line"><a name="l01526"></a><span class="lineno"> 1526</span>&#160;                            <span class="keywordflow">if</span> (printMe || CT.numOutstandingPings &gt; 0) {</div>
<div class="line"><a name="l01527"></a><span class="lineno"> 1527</span>&#160;                                String firstPart = <span class="stringliteral">&quot;---- &quot;</span> + i + <span class="stringliteral">&quot; &quot;</span> + CT.username.replace(<span class="stringliteral">&quot;.&quot;</span> + TOP_LEVEL_DOMAIN, <span class="stringliteral">&quot;&quot;</span>) + <span class="stringliteral">&quot; &quot;</span>;</div>
<div class="line"><a name="l01528"></a><span class="lineno"> 1528</span>&#160;                                <span class="keywordtype">int</span> initialLength = firstPart.length();</div>
<div class="line"><a name="l01529"></a><span class="lineno"> 1529</span>&#160;                                <span class="keywordflow">for</span> (<span class="keywordtype">int</span> m = initialLength; m &lt; 40; m++)</div>
<div class="line"><a name="l01530"></a><span class="lineno"> 1530</span>&#160;                                    firstPart += <span class="charliteral">&#39; &#39;</span>;</div>
<div class="line"><a name="l01531"></a><span class="lineno"> 1531</span>&#160;                                diagnostic += <span class="stringliteral">&quot;\n&quot;</span> + (firstPart + (<span class="keyword">new</span> Date(CT.lastSeen)).toString().substring(4, 19) + <span class="stringliteral">&quot;, &quot;</span></div>
<div class="line"><a name="l01532"></a><span class="lineno"> 1532</span>&#160;                                        + (System.currentTimeMillis() - CT.lastSeen) / 1000L + <span class="stringliteral">&quot; secs ago&quot;</span></div>
<div class="line"><a name="l01533"></a><span class="lineno"> 1533</span>&#160;                                        + (CT.numOutstandingPings &gt; 0 ? <span class="stringliteral">&quot;; num pings=&quot;</span> + CT.numOutstandingPings : <span class="stringliteral">&quot;&quot;</span>));</div>
<div class="line"><a name="l01534"></a><span class="lineno"> 1534</span>&#160;                                <span class="keywordflow">if</span> (CT.numOutstandingPings &gt; theMostPings)</div>
<div class="line"><a name="l01535"></a><span class="lineno"> 1535</span>&#160;                                    theMostPings = CT.numOutstandingPings;</div>
<div class="line"><a name="l01536"></a><span class="lineno"> 1536</span>&#160;                            }</div>
<div class="line"><a name="l01537"></a><span class="lineno"> 1537</span>&#160;                            <span class="keywordflow">if</span> (CT.isOnNotice())</div>
<div class="line"><a name="l01538"></a><span class="lineno"> 1538</span>&#160;                                clist.add(CT);</div>
<div class="line"><a name="l01539"></a><span class="lineno"> 1539</span>&#160;                            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (CT.getLastSeen() &lt; oldestTime &amp;&amp; !CT.equals(lastOldestClientName)) {</div>
<div class="line"><a name="l01540"></a><span class="lineno"> 1540</span>&#160;                                oldestTime = CT.getLastSeen();</div>
<div class="line"><a name="l01541"></a><span class="lineno"> 1541</span>&#160;                                oldestClientName = CT;</div>
<div class="line"><a name="l01542"></a><span class="lineno"> 1542</span>&#160;                            }</div>
<div class="line"><a name="l01543"></a><span class="lineno"> 1543</span>&#160;                        }</div>
<div class="line"><a name="l01544"></a><span class="lineno"> 1544</span>&#160;</div>
<div class="line"><a name="l01545"></a><span class="lineno"> 1545</span>&#160;                        <span class="keywordflow">if</span> (printMe)</div>
<div class="line"><a name="l01546"></a><span class="lineno"> 1546</span>&#160;                            randomCycleModulo = (int) (Math.random() * 5.0);</div>
<div class="line"><a name="l01547"></a><span class="lineno"> 1547</span>&#160;                        printMe = printMe || theMostPings &gt; 2;</div>
<div class="line"><a name="l01548"></a><span class="lineno"> 1548</span>&#160;                        <span class="comment">// if (printMe)</span></div>
<div class="line"><a name="l01549"></a><span class="lineno"> 1549</span>&#160;                        <span class="comment">// logger.fine(diagnostic + &quot;\n\t(&quot; + randomCycleModulo + &quot;)&quot;);</span></div>
<div class="line"><a name="l01550"></a><span class="lineno"> 1550</span>&#160;</div>
<div class="line"><a name="l01551"></a><span class="lineno"> 1551</span>&#160;                        clist.add(oldestClientName);</div>
<div class="line"><a name="l01552"></a><span class="lineno"> 1552</span>&#160;                        lastOldestClientName = oldestClientName;</div>
<div class="line"><a name="l01553"></a><span class="lineno"> 1553</span>&#160;</div>
<div class="line"><a name="l01554"></a><span class="lineno"> 1554</span>&#160;                        <span class="keywordflow">for</span> (ClientThread CT : clist) {</div>
<div class="line"><a name="l01555"></a><span class="lineno"> 1555</span>&#160;                            <span class="keywordflow">if</span> (CT == null)</div>
<div class="line"><a name="l01556"></a><span class="lineno"> 1556</span>&#160;                                <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l01557"></a><span class="lineno"> 1557</span>&#160;                            catchSleep(1);</div>
<div class="line"><a name="l01558"></a><span class="lineno"> 1558</span>&#160;                            <span class="keywordflow">if</span> (printMe)</div>
<div class="line"><a name="l01559"></a><span class="lineno"> 1559</span>&#160;                                logger.fine(<span class="stringliteral">&quot;Sending isAlive message to &quot;</span> + CT);</div>
<div class="line"><a name="l01560"></a><span class="lineno"> 1560</span>&#160;                            MessageCarrierXML mc = MessageCarrierXML.getIsAlive(<a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#a738da0a18944421491268d2220a3c7a4">SPECIAL_SERVER_MESSAGE_USERNAME</a>, CT.username);</div>
<div class="line"><a name="l01561"></a><span class="lineno"> 1561</span>&#160;                            CT.incrementNumOutstandingPings();</div>
<div class="line"><a name="l01562"></a><span class="lineno"> 1562</span>&#160;                            <span class="keywordflow">if</span> (CT.numOutstandingPings &gt; <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#abb85ff8b189da86dfc20bd3313ea79d6">MAX_CONSECUTIVE_UNPONGED_PINGS</a>) {</div>
<div class="line"><a name="l01563"></a><span class="lineno"> 1563</span>&#160;                                logger.warning(<span class="stringliteral">&quot;Too many pings (&quot;</span> + CT.numOutstandingPings + <span class="stringliteral">&quot;) to the client &quot;</span> + CT.username</div>
<div class="line"><a name="l01564"></a><span class="lineno"> 1564</span>&#160;                                        + <span class="stringliteral">&quot;; removing it!&quot;</span>);</div>
<div class="line"><a name="l01565"></a><span class="lineno"> 1565</span>&#160;                                <span class="keyword">remove</span>(CT);</div>
<div class="line"><a name="l01566"></a><span class="lineno"> 1566</span>&#160;                                CT.close();</div>
<div class="line"><a name="l01567"></a><span class="lineno"> 1567</span>&#160;                                numRemovedForPings2++;</div>
<div class="line"><a name="l01568"></a><span class="lineno"> 1568</span>&#160;                                CT = null; <span class="comment">// Not really necessary, but it makes me feel better.</span></div>
<div class="line"><a name="l01569"></a><span class="lineno"> 1569</span>&#160;                                <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l01570"></a><span class="lineno"> 1570</span>&#160;                            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (CT.numOutstandingPings &gt; <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#abb85ff8b189da86dfc20bd3313ea79d6">MAX_CONSECUTIVE_UNPONGED_PINGS</a> / 2) {</div>
<div class="line"><a name="l01571"></a><span class="lineno"> 1571</span>&#160;                                logger.warning(<span class="stringliteral">&quot;Almost too many pings (&quot;</span> + CT.numOutstandingPings + <span class="stringliteral">&quot;) to the client &quot;</span> + CT.username</div>
<div class="line"><a name="l01572"></a><span class="lineno"> 1572</span>&#160;                                        + <span class="stringliteral">&quot;. currentTimeMillis=&quot;</span> + System.currentTimeMillis());</div>
<div class="line"><a name="l01573"></a><span class="lineno"> 1573</span>&#160;                            }</div>
<div class="line"><a name="l01574"></a><span class="lineno"> 1574</span>&#160;                            <span class="comment">// This is a read-only message and DOES NOT NEED a signature.</span></div>
<div class="line"><a name="l01575"></a><span class="lineno"> 1575</span>&#160;                            broadcast(mc);</div>
<div class="line"><a name="l01576"></a><span class="lineno"> 1576</span>&#160;                        }</div>
<div class="line"><a name="l01577"></a><span class="lineno"> 1577</span>&#160;</div>
<div class="line"><a name="l01578"></a><span class="lineno"> 1578</span>&#160;                        <span class="comment">/*</span></div>
<div class="line"><a name="l01579"></a><span class="lineno"> 1579</span>&#160;<span class="comment">                         * TODO Maybe the right way to do this is to _broadcast_ a &quot;Are You Alive&quot; message (really, broadcast with</span></div>
<div class="line"><a name="l01580"></a><span class="lineno"> 1580</span>&#160;<span class="comment">                         * one message to anyone that may be listening) and capture the results. In this case, it would be nice to</span></div>
<div class="line"><a name="l01581"></a><span class="lineno"> 1581</span>&#160;<span class="comment">                         * have each client wait some random number of milliseconds so the messages come in with few(er) collisions.</span></div>
<div class="line"><a name="l01582"></a><span class="lineno"> 1582</span>&#160;<span class="comment">                         * The method here works, but it takes some time to go through all the clients. This delay means that it is</span></div>
<div class="line"><a name="l01583"></a><span class="lineno"> 1583</span>&#160;<span class="comment">                         * a long time before we actually learn that a client is not there.</span></div>
<div class="line"><a name="l01584"></a><span class="lineno"> 1584</span>&#160;<span class="comment">                         * </span></div>
<div class="line"><a name="l01585"></a><span class="lineno"> 1585</span>&#160;<span class="comment">                         * This would be easy (-ish) to do if/when we move to full publish/subscribe. There would be a well-known</span></div>
<div class="line"><a name="l01586"></a><span class="lineno"> 1586</span>&#160;<span class="comment">                         * subject called something like &quot;HeartbeatSubject&quot; that each and every client must subscribe to.</span></div>
<div class="line"><a name="l01587"></a><span class="lineno"> 1587</span>&#160;<span class="comment">                         */</span></div>
<div class="line"><a name="l01588"></a><span class="lineno"> 1588</span>&#160;</div>
<div class="line"><a name="l01589"></a><span class="lineno"> 1589</span>&#160;                        <span class="comment">/*</span></div>
<div class="line"><a name="l01590"></a><span class="lineno"> 1590</span>&#160;<span class="comment">                         * The idea here is to ping any client that is &quot;on notice,&quot; plus the oldest client. If I have implemented</span></div>
<div class="line"><a name="l01591"></a><span class="lineno"> 1591</span>&#160;<span class="comment">                         * this right and all clients are prompt about reporting, then in the steady state it will march through and</span></div>
<div class="line"><a name="l01592"></a><span class="lineno"> 1592</span>&#160;<span class="comment">                         * ping the clients in the same order. Clients that send something to the server (like the Facades) will get</span></div>
<div class="line"><a name="l01593"></a><span class="lineno"> 1593</span>&#160;<span class="comment">                         * pushed to the end of the list, though.</span></div>
<div class="line"><a name="l01594"></a><span class="lineno"> 1594</span>&#160;<span class="comment">                         */</span></div>
<div class="line"><a name="l01595"></a><span class="lineno"> 1595</span>&#160;</div>
<div class="line"><a name="l01596"></a><span class="lineno"> 1596</span>&#160;                        nextClient = (++nextClient) % listOfMessagingClients.size();</div>
<div class="line"><a name="l01597"></a><span class="lineno"> 1597</span>&#160;                        <span class="keywordflow">if</span> (nextClient == 0) {</div>
<div class="line"><a name="l01598"></a><span class="lineno"> 1598</span>&#160;                            <span class="keywordtype">boolean</span> old = (lastPrint + FIFTEEN_MINUTES) &lt; System.currentTimeMillis();</div>
<div class="line"><a name="l01599"></a><span class="lineno"> 1599</span>&#160;                            <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#af24f72f6ce9d270c33afb4032d9c968b">performDiagnostics</a>(old);</div>
<div class="line"><a name="l01600"></a><span class="lineno"> 1600</span>&#160;</div>
<div class="line"><a name="l01601"></a><span class="lineno"> 1601</span>&#160;                            <span class="keywordflow">if</span> (old)</div>
<div class="line"><a name="l01602"></a><span class="lineno"> 1602</span>&#160;                                lastPrint = System.currentTimeMillis();</div>
<div class="line"><a name="l01603"></a><span class="lineno"> 1603</span>&#160;                        }</div>
<div class="line"><a name="l01604"></a><span class="lineno"> 1604</span>&#160;                    } <span class="keywordflow">catch</span> (Exception e) {</div>
<div class="line"><a name="l01605"></a><span class="lineno"> 1605</span>&#160;                        <span class="comment">// Random, unexpected exceptions have bitten me before (killing this thread); don&#39;t let that happen again.</span></div>
<div class="line"><a name="l01606"></a><span class="lineno"> 1606</span>&#160;                        logger.warning(<a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#afe655a915ee116333ee6f1c8331b7929">exceptionString</a>(e));</div>
<div class="line"><a name="l01607"></a><span class="lineno"> 1607</span>&#160;                    }</div>
<div class="line"><a name="l01608"></a><span class="lineno"> 1608</span>&#160;            }</div>
<div class="line"><a name="l01609"></a><span class="lineno"> 1609</span>&#160;        }.start();</div>
<div class="line"><a name="l01610"></a><span class="lineno"> 1610</span>&#160;    }</div>
<div class="line"><a name="l01611"></a><span class="lineno"> 1611</span>&#160;</div>
<div class="line"><a name="l01612"></a><span class="lineno"> 1612</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l01613"></a><span class="lineno"> 1613</span>&#160;<span class="comment">     * For the GUI to stop the server</span></div>
<div class="line"><a name="l01614"></a><span class="lineno"> 1614</span>&#160;<span class="comment">     */</span></div>
<div class="line"><a name="l01615"></a><span class="lineno"> 1615</span>&#160;    @SuppressWarnings(<span class="stringliteral">&quot;resource&quot;</span>)</div>
<div class="line"><a name="l01616"></a><span class="lineno"><a class="line" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#a2ab9736895b528ec810dd27eb5761295"> 1616</a></span>&#160;    protected <span class="keywordtype">void</span> <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#a2ab9736895b528ec810dd27eb5761295">stop</a>() {</div>
<div class="line"><a name="l01617"></a><span class="lineno"> 1617</span>&#160;        keepGoing = <span class="keyword">false</span>;</div>
<div class="line"><a name="l01618"></a><span class="lineno"> 1618</span>&#160;        <span class="comment">// connect to myself as Client to exit statement</span></div>
<div class="line"><a name="l01619"></a><span class="lineno"> 1619</span>&#160;        <span class="comment">// Socket socket = serverSocket.accept();</span></div>
<div class="line"><a name="l01620"></a><span class="lineno"> 1620</span>&#160;        <span class="keywordflow">try</span> {</div>
<div class="line"><a name="l01621"></a><span class="lineno"> 1621</span>&#160;            <span class="comment">// Huh? (11/04/2014)</span></div>
<div class="line"><a name="l01622"></a><span class="lineno"> 1622</span>&#160;            <span class="keyword">new</span> Socket(<span class="stringliteral">&quot;localhost&quot;</span>, port);</div>
<div class="line"><a name="l01623"></a><span class="lineno"> 1623</span>&#160;        } <span class="keywordflow">catch</span> (Exception e) {</div>
<div class="line"><a name="l01624"></a><span class="lineno"> 1624</span>&#160;            <span class="comment">// nothing I can really do</span></div>
<div class="line"><a name="l01625"></a><span class="lineno"> 1625</span>&#160;            logger.warning(<a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#afe655a915ee116333ee6f1c8331b7929">exceptionString</a>(e));</div>
<div class="line"><a name="l01626"></a><span class="lineno"> 1626</span>&#160;        }</div>
<div class="line"><a name="l01627"></a><span class="lineno"> 1627</span>&#160;    }</div>
<div class="line"><a name="l01628"></a><span class="lineno"> 1628</span>&#160;</div>
<div class="line"><a name="l01629"></a><span class="lineno"> 1629</span>&#160;    @Override</div>
<div class="line"><a name="l01630"></a><span class="lineno"><a class="line" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#a8ca524f1db3320d40d3e5c0144802765"> 1630</a></span>&#160;    <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#a8ca524f1db3320d40d3e5c0144802765">javaHasChanged</a>() {</div>
<div class="line"><a name="l01631"></a><span class="lineno"> 1631</span>&#160;        println(getClass(), <span class="stringliteral">&quot;The Java version has changed.&quot;</span>);</div>
<div class="line"><a name="l01632"></a><span class="lineno"> 1632</span>&#160;    }</div>
<div class="line"><a name="l01633"></a><span class="lineno"> 1633</span>&#160;</div>
<div class="line"><a name="l01634"></a><span class="lineno"> 1634</span>&#160;}</div>
<div class="ttc" id="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1messages_1_1EmergencyMessXML_html"><div class="ttname"><a href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1messages_1_1EmergencyMessXML.html">gov.fnal.ppd.dd.xml.messages.EmergencyMessXML</a></div><div class="ttdef"><b>Definition:</b> <a href="EmergencyMessXML_8java_source.html#l00015">EmergencyMessXML.java:15</a></div></div>
<div class="ttc" id="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer_html_a69cf69b0f944a33ba7e1b9c32dd60ee6"><div class="ttname"><a href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#a69cf69b0f944a33ba7e1b9c32dd60ee6">gov.fnal.ppd.dd.chat.MessagingServer.start</a></div><div class="ttdeci">void start()</div><div class="ttdef"><b>Definition:</b> <a href="MessagingServer_8java_source.html#l01226">MessagingServer.java:1226</a></div></div>
<div class="ttc" id="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer_html_ad4cb5effceeb2b11031e3cf2ec0e5939"><div class="ttname"><a href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#ad4cb5effceeb2b11031e3cf2ec0e5939">gov.fnal.ppd.dd.chat.MessagingServer.broadcast</a></div><div class="ttdeci">void broadcast(MessageCarrierXML mc)</div><div class="ttdef"><b>Definition:</b> <a href="MessagingServer_8java_source.html#l00945">MessagingServer.java:945</a></div></div>
<div class="ttc" id="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer_html_a90da887bb782b08af3fb1dbce8c3e502"><div class="ttname"><a href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#a90da887bb782b08af3fb1dbce8c3e502">gov.fnal.ppd.dd.chat.MessagingServer.showAllClientsConnectedNow</a></div><div class="ttdeci">void showAllClientsConnectedNow()</div><div class="ttdef"><b>Definition:</b> <a href="MessagingServer_8java_source.html#l01448">MessagingServer.java:1448</a></div></div>
<div class="ttc" id="classgov_1_1fnal_1_1ppd_1_1dd_1_1interfaces_1_1DatabaseNotVisibleException_html"><div class="ttname"><a href="classgov_1_1fnal_1_1ppd_1_1dd_1_1interfaces_1_1DatabaseNotVisibleException.html">gov.fnal.ppd.dd.interfaces.DatabaseNotVisibleException</a></div><div class="ttdef"><b>Definition:</b> <a href="dd_2interfaces_2DatabaseNotVisibleException_8java_source.html#l00014">DatabaseNotVisibleException.java:14</a></div></div>
<div class="ttc" id="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1MyXMLMarshaller_html"><div class="ttname"><a href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1MyXMLMarshaller.html">gov.fnal.ppd.dd.xml.MyXMLMarshaller</a></div><div class="ttdef"><b>Definition:</b> <a href="MyXMLMarshaller_8java_source.html#l00021">MyXMLMarshaller.java:21</a></div></div>
<div class="ttc" id="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1MessageCarrierXML_html_a04d65b843d37b0e9f2e8026ec00b95ff"><div class="ttname"><a href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1MessageCarrierXML.html#a04d65b843d37b0e9f2e8026ec00b95ff">gov.fnal.ppd.dd.xml.MessageCarrierXML.isUsernameMatch</a></div><div class="ttdeci">static boolean isUsernameMatch(final String theNameFromTheServer, final String theNameFromTheClient)</div><div class="ttdef"><b>Definition:</b> <a href="MessageCarrierXML_8java_source.html#l00255">MessageCarrierXML.java:255</a></div></div>
<div class="ttc" id="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer_html_a3fe04e43605b1c81c063cf9d334fb763"><div class="ttname"><a href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#a3fe04e43605b1c81c063cf9d334fb763">gov.fnal.ppd.dd.chat.MessagingServer.numRemovedNullClientThread</a></div><div class="ttdeci">int numRemovedNullClientThread</div><div class="ttdef"><b>Definition:</b> <a href="MessagingServer_8java_source.html#l00858">MessagingServer.java:858</a></div></div>
<div class="ttc" id="classgov_1_1fnal_1_1ppd_1_1dd_1_1util_1_1specific_1_1ObjectSigning_html_ab51a44acbc4795b78f9b608c361e9369"><div class="ttname"><a href="classgov_1_1fnal_1_1ppd_1_1dd_1_1util_1_1specific_1_1ObjectSigning.html#ab51a44acbc4795b78f9b608c361e9369">gov.fnal.ppd.dd.util.specific.ObjectSigning.dropClient</a></div><div class="ttdeci">static boolean dropClient(final String client)</div><div class="ttdef"><b>Definition:</b> <a href="ObjectSigning_8java_source.html#l00112">ObjectSigning.java:112</a></div></div>
<div class="ttc" id="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer_html_abb85ff8b189da86dfc20bd3313ea79d6"><div class="ttname"><a href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#abb85ff8b189da86dfc20bd3313ea79d6">gov.fnal.ppd.dd.chat.MessagingServer.MAX_CONSECUTIVE_UNPONGED_PINGS</a></div><div class="ttdeci">static final int MAX_CONSECUTIVE_UNPONGED_PINGS</div><div class="ttdef"><b>Definition:</b> <a href="MessagingServer_8java_source.html#l00188">MessagingServer.java:188</a></div></div>
<div class="ttc" id="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer_html_a189ff6081d21eb1a9c98887d84e23b17"><div class="ttname"><a href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#a189ff6081d21eb1a9c98887d84e23b17">gov.fnal.ppd.dd.chat.MessagingServer.numRemovedExitedForeverLoop</a></div><div class="ttdeci">int numRemovedExitedForeverLoop</div><div class="ttdef"><b>Definition:</b> <a href="MessagingServer_8java_source.html#l00861">MessagingServer.java:861</a></div></div>
<div class="ttc" id="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1LoggerForDebugging_html_a463354c7650543e5a0b2f6806d2dbf81"><div class="ttname"><a href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1LoggerForDebugging.html#a463354c7650543e5a0b2f6806d2dbf81">gov.fnal.ppd.dd.chat.LoggerForDebugging.fine</a></div><div class="ttdeci">void fine(String string)</div><div class="ttdef"><b>Definition:</b> <a href="LoggerForDebugging_8java_source.html#l00060">LoggerForDebugging.java:60</a></div></div>
<div class="ttc" id="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer_html_ab986fa29bcdc51bd186ad23e1c699426"><div class="ttname"><a href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#ab986fa29bcdc51bd186ad23e1c699426">gov.fnal.ppd.dd.chat.MessagingServer.numRemovedNullDate</a></div><div class="ttdeci">int numRemovedNullDate</div><div class="ttdef"><b>Definition:</b> <a href="MessagingServer_8java_source.html#l00860">MessagingServer.java:860</a></div></div>
<div class="ttc" id="interfacegov_1_1fnal_1_1ppd_1_1dd_1_1util_1_1nonguiUtils_1_1JavaChangeListener_html"><div class="ttname"><a href="interfacegov_1_1fnal_1_1ppd_1_1dd_1_1util_1_1nonguiUtils_1_1JavaChangeListener.html">gov.fnal.ppd.dd.util.nonguiUtils.JavaChangeListener</a></div><div class="ttdef"><b>Definition:</b> <a href="JavaChangeListener_8java_source.html#l00009">JavaChangeListener.java:9</a></div></div>
<div class="ttc" id="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer_html_a9b02c801edad834dcc2a0c96071900af"><div class="ttname"><a href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#a9b02c801edad834dcc2a0c96071900af">gov.fnal.ppd.dd.chat.MessagingServer.MessagingServer</a></div><div class="ttdeci">MessagingServer(int port)</div><div class="ttdef"><b>Definition:</b> <a href="MessagingServer_8java_source.html#l00884">MessagingServer.java:884</a></div></div>
<div class="ttc" id="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer_html_af24f72f6ce9d270c33afb4032d9c968b"><div class="ttname"><a href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#af24f72f6ce9d270c33afb4032d9c968b">gov.fnal.ppd.dd.chat.MessagingServer.performDiagnostics</a></div><div class="ttdeci">void performDiagnostics(boolean show)</div><div class="ttdef"><b>Definition:</b> <a href="MessagingServer_8java_source.html#l01046">MessagingServer.java:1046</a></div></div>
<div class="ttc" id="classgov_1_1fnal_1_1ppd_1_1dd_1_1util_1_1specific_1_1ObjectSigning_html"><div class="ttname"><a href="classgov_1_1fnal_1_1ppd_1_1dd_1_1util_1_1specific_1_1ObjectSigning.html">gov.fnal.ppd.dd.util.specific.ObjectSigning</a></div><div class="ttdef"><b>Definition:</b> <a href="ObjectSigning_8java_source.html#l00055">ObjectSigning.java:55</a></div></div>
<div class="ttc" id="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1messages_1_1ChangeChannelReply_html"><div class="ttname"><a href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1messages_1_1ChangeChannelReply.html">gov.fnal.ppd.dd.xml.messages.ChangeChannelReply</a></div><div class="ttdef"><b>Definition:</b> <a href="ChangeChannelReply_8java_source.html#l00019">ChangeChannelReply.java:19</a></div></div>
<div class="ttc" id="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer_html_ac727c375b30722fb0d0a88f27eb97954"><div class="ttname"><a href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#ac727c375b30722fb0d0a88f27eb97954">gov.fnal.ppd.dd.chat.MessagingServer.sdf</a></div><div class="ttdeci">SimpleDateFormat sdf</div><div class="ttdef"><b>Definition:</b> <a href="MessagingServer_8java_source.html#l00845">MessagingServer.java:845</a></div></div>
<div class="ttc" id="classgov_1_1fnal_1_1ppd_1_1dd_1_1util_1_1nonguiUtils_1_1JavaVersion_html"><div class="ttname"><a href="classgov_1_1fnal_1_1ppd_1_1dd_1_1util_1_1nonguiUtils_1_1JavaVersion.html">gov.fnal.ppd.dd.util.nonguiUtils.JavaVersion</a></div><div class="ttdef"><b>Definition:</b> <a href="JavaVersion_8java_source.html#l00023">JavaVersion.java:23</a></div></div>
<div class="ttc" id="classgov_1_1fnal_1_1ppd_1_1dd_1_1util_1_1version_1_1VersionInformation_html"><div class="ttname"><a href="classgov_1_1fnal_1_1ppd_1_1dd_1_1util_1_1version_1_1VersionInformation.html">gov.fnal.ppd.dd.util.version.VersionInformation</a></div><div class="ttdef"><b>Definition:</b> <a href="VersionInformation_8java_source.html#l00058">VersionInformation.java:58</a></div></div>
<div class="ttc" id="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1LoggerForDebugging_html"><div class="ttname"><a href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1LoggerForDebugging.html">gov.fnal.ppd.dd.chat.LoggerForDebugging</a></div><div class="ttdef"><b>Definition:</b> <a href="LoggerForDebugging_8java_source.html#l00018">LoggerForDebugging.java:18</a></div></div>
<div class="ttc" id="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1messages_1_1YesIAmAliveMessage_html"><div class="ttname"><a href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1messages_1_1YesIAmAliveMessage.html">gov.fnal.ppd.dd.xml.messages.YesIAmAliveMessage</a></div><div class="ttdef"><b>Definition:</b> <a href="YesIAmAliveMessage_8java_source.html#l00015">YesIAmAliveMessage.java:15</a></div></div>
<div class="ttc" id="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1MessageCarrierXML_html_a9ab80285c3975daf5032897069ed0b80"><div class="ttname"><a href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1MessageCarrierXML.html#a9ab80285c3975daf5032897069ed0b80">gov.fnal.ppd.dd.xml.MessageCarrierXML.isReadOnly</a></div><div class="ttdeci">boolean isReadOnly()</div><div class="ttdef"><b>Definition:</b> <a href="MessageCarrierXML_8java_source.html#l00240">MessageCarrierXML.java:240</a></div></div>
<div class="ttc" id="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1messages_1_1ErrorMessage_html"><div class="ttname"><a href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1messages_1_1ErrorMessage.html">gov.fnal.ppd.dd.xml.messages.ErrorMessage</a></div><div class="ttdef"><b>Definition:</b> <a href="ErrorMessage_8java_source.html#l00014">ErrorMessage.java:14</a></div></div>
<div class="ttc" id="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1MessageCarrierXML_html_a1b006e6ae04358ab235244fe4a4fbfdf"><div class="ttname"><a href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1MessageCarrierXML.html#a1b006e6ae04358ab235244fe4a4fbfdf">gov.fnal.ppd.dd.xml.MessageCarrierXML.isSignatureValid</a></div><div class="ttdeci">boolean isSignatureValid()</div><div class="ttdef"><b>Definition:</b> <a href="MessageCarrierXML_8java_source.html#l00286">MessageCarrierXML.java:286</a></div></div>
<div class="ttc" id="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer_html_a738da0a18944421491268d2220a3c7a4"><div class="ttname"><a href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#a738da0a18944421491268d2220a3c7a4">gov.fnal.ppd.dd.chat.MessagingServer.SPECIAL_SERVER_MESSAGE_USERNAME</a></div><div class="ttdeci">static final String SPECIAL_SERVER_MESSAGE_USERNAME</div><div class="ttdef"><b>Definition:</b> <a href="MessagingServer_8java_source.html#l00186">MessagingServer.java:186</a></div></div>
<div class="ttc" id="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer_html_afe655a915ee116333ee6f1c8331b7929"><div class="ttname"><a href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#afe655a915ee116333ee6f1c8331b7929">gov.fnal.ppd.dd.chat.MessagingServer.exceptionString</a></div><div class="ttdeci">String exceptionString(Exception e)</div><div class="ttdef"><b>Definition:</b> <a href="MessagingServer_8java_source.html#l01026">MessagingServer.java:1026</a></div></div>
<div class="ttc" id="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1SubscriptionSubject_html"><div class="ttname"><a href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1SubscriptionSubject.html">gov.fnal.ppd.dd.xml.SubscriptionSubject</a></div><div class="ttdef"><b>Definition:</b> <a href="SubscriptionSubject_8java_source.html#l00019">SubscriptionSubject.java:19</a></div></div>
<div class="ttc" id="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer_html_ae9c73322e842357c87634a60426e5bf0"><div class="ttname"><a href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#ae9c73322e842357c87634a60426e5bf0">gov.fnal.ppd.dd.chat.MessagingServer.numRemovedBadWriteSeen</a></div><div class="ttdeci">int numRemovedBadWriteSeen</div><div class="ttdef"><b>Definition:</b> <a href="MessagingServer_8java_source.html#l00857">MessagingServer.java:857</a></div></div>
<div class="ttc" id="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer_html_a6847562b2441991b550f7b3cb7fe8f2d"><div class="ttname"><a href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#a6847562b2441991b550f7b3cb7fe8f2d">gov.fnal.ppd.dd.chat.MessagingServer.totalMesssagesHandled</a></div><div class="ttdeci">int totalMesssagesHandled</div><div class="ttdef"><b>Definition:</b> <a href="MessagingServer_8java_source.html#l00852">MessagingServer.java:852</a></div></div>
<div class="ttc" id="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1MessageCarrierXML_html_acd02da5d8151d98e634df355e0525d00"><div class="ttname"><a href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1MessageCarrierXML.html#acd02da5d8151d98e634df355e0525d00">gov.fnal.ppd.dd.xml.MessageCarrierXML.getMessageValue</a></div><div class="ttdeci">MessagingDataXML getMessageValue()</div><div class="ttdef"><b>Definition:</b> <a href="MessageCarrierXML_8java_source.html#l00219">MessageCarrierXML.java:219</a></div></div>
<div class="ttc" id="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1MessageCarrierXML_html_a5159aef548c8c4fe564adc7d7d622305"><div class="ttname"><a href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1MessageCarrierXML.html#a5159aef548c8c4fe564adc7d7d622305">gov.fnal.ppd.dd.xml.MessageCarrierXML.getErrorMessage</a></div><div class="ttdeci">static MessageCarrierXML getErrorMessage(final String from, final String to, final String message)</div><div class="ttdef"><b>Definition:</b> <a href="MessageCarrierXML_8java_source.html#l00131">MessageCarrierXML.java:131</a></div></div>
<div class="ttc" id="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer_html_acc91232824dd5e89347e0d8ac29abae8"><div class="ttname"><a href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#acc91232824dd5e89347e0d8ac29abae8">gov.fnal.ppd.dd.chat.MessagingServer.logger</a></div><div class="ttdeci">LoggerForDebugging logger</div><div class="ttdef"><b>Definition:</b> <a href="MessagingServer_8java_source.html#l00875">MessagingServer.java:875</a></div></div>
<div class="ttc" id="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer_html_a8ca524f1db3320d40d3e5c0144802765"><div class="ttname"><a href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#a8ca524f1db3320d40d3e5c0144802765">gov.fnal.ppd.dd.chat.MessagingServer.javaHasChanged</a></div><div class="ttdeci">void javaHasChanged()</div><div class="ttdef"><b>Definition:</b> <a href="MessagingServer_8java_source.html#l01630">MessagingServer.java:1630</a></div></div>
<div class="ttc" id="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1MessageCarrierXML_html"><div class="ttname"><a href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1MessageCarrierXML.html">gov.fnal.ppd.dd.xml.MessageCarrierXML</a></div><div class="ttdef"><b>Definition:</b> <a href="MessageCarrierXML_8java_source.html#l00054">MessageCarrierXML.java:54</a></div></div>
<div class="ttc" id="classgov_1_1fnal_1_1ppd_1_1dd_1_1db_1_1ConnectionToDatabase_html"><div class="ttname"><a href="classgov_1_1fnal_1_1ppd_1_1dd_1_1db_1_1ConnectionToDatabase.html">gov.fnal.ppd.dd.db.ConnectionToDatabase</a></div><div class="ttdef"><b>Definition:</b> <a href="ConnectionToDatabase_8java_source.html#l00028">ConnectionToDatabase.java:28</a></div></div>
<div class="ttc" id="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer_html_a84d7bc143f1eee20c7e39ce9024783c9"><div class="ttname"><a href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#a84d7bc143f1eee20c7e39ce9024783c9">gov.fnal.ppd.dd.chat.MessagingServer.numRemovedNullUsername</a></div><div class="ttdeci">int numRemovedNullUsername</div><div class="ttdef"><b>Definition:</b> <a href="MessagingServer_8java_source.html#l00859">MessagingServer.java:859</a></div></div>
<div class="ttc" id="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer_html"><div class="ttname"><a href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html">gov.fnal.ppd.dd.chat.MessagingServer</a></div><div class="ttdef"><b>Definition:</b> <a href="MessagingServer_8java_source.html#l00175">MessagingServer.java:175</a></div></div>
<div class="ttc" id="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1messages_1_1AreYouAliveMessage_html"><div class="ttname"><a href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1messages_1_1AreYouAliveMessage.html">gov.fnal.ppd.dd.xml.messages.AreYouAliveMessage</a></div><div class="ttdef"><b>Definition:</b> <a href="AreYouAliveMessage_8java_source.html#l00011">AreYouAliveMessage.java:11</a></div></div>
<div class="ttc" id="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1UnrecognizedCommunicationException_html"><div class="ttname"><a href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1UnrecognizedCommunicationException.html">gov.fnal.ppd.dd.chat.UnrecognizedCommunicationException</a></div><div class="ttdef"><b>Definition:</b> <a href="UnrecognizedCommunicationException_8java_source.html#l00009">UnrecognizedCommunicationException.java:9</a></div></div>
<div class="ttc" id="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1messages_1_1WhoIsInMessage_html"><div class="ttname"><a href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1messages_1_1WhoIsInMessage.html">gov.fnal.ppd.dd.xml.messages.WhoIsInMessage</a></div><div class="ttdef"><b>Definition:</b> <a href="WhoIsInMessage_8java_source.html#l00011">WhoIsInMessage.java:11</a></div></div>
<div class="ttc" id="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1MessageCarrierXML_html_a905ca8052d9b8bb961c6e267c1e0b862"><div class="ttname"><a href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1MessageCarrierXML.html#a905ca8052d9b8bb961c6e267c1e0b862">gov.fnal.ppd.dd.xml.MessageCarrierXML.getIAmAlive</a></div><div class="ttdeci">static MessageCarrierXML getIAmAlive(final String from, final String to, long time)</div><div class="ttdef"><b>Definition:</b> <a href="MessageCarrierXML_8java_source.html#l00110">MessageCarrierXML.java:110</a></div></div>
<div class="ttc" id="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer_html_a2ab9736895b528ec810dd27eb5761295"><div class="ttname"><a href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1MessagingServer.html#a2ab9736895b528ec810dd27eb5761295">gov.fnal.ppd.dd.chat.MessagingServer.stop</a></div><div class="ttdeci">void stop()</div><div class="ttdef"><b>Definition:</b> <a href="MessagingServer_8java_source.html#l01616">MessagingServer.java:1616</a></div></div>
<div class="ttc" id="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1messages_1_1LoginMessage_html"><div class="ttname"><a href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1messages_1_1LoginMessage.html">gov.fnal.ppd.dd.xml.messages.LoginMessage</a></div><div class="ttdef"><b>Definition:</b> <a href="LoginMessage_8java_source.html#l00015">LoginMessage.java:15</a></div></div>
<div class="ttc" id="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1LoggerForDebugging_html_a2d1f413fb8fda0b558935ee6734cf1c5"><div class="ttname"><a href="classgov_1_1fnal_1_1ppd_1_1dd_1_1chat_1_1LoggerForDebugging.html#a2d1f413fb8fda0b558935ee6734cf1c5">gov.fnal.ppd.dd.chat.LoggerForDebugging.getLogger</a></div><div class="ttdeci">Logger getLogger()</div><div class="ttdef"><b>Definition:</b> <a href="LoggerForDebugging_8java_source.html#l00110">LoggerForDebugging.java:110</a></div></div>
<div class="ttc" id="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1MessageCarrierXML_html_af46fdc989fa42e3371cb942a3394b945"><div class="ttname"><a href="classgov_1_1fnal_1_1ppd_1_1dd_1_1xml_1_1MessageCarrierXML.html#af46fdc989fa42e3371cb942a3394b945">gov.fnal.ppd.dd.xml.MessageCarrierXML.getMessageRecipient</a></div><div class="ttdeci">String getMessageRecipient()</div><div class="ttdef"><b>Definition:</b> <a href="MessageCarrierXML_8java_source.html#l00188">MessageCarrierXML.java:188</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><a class="el" href="dir_7d62d1059ec54d5dc63de032b83eaa8e.html">gov</a></li><li class="navelem"><a class="el" href="dir_de59b757cb762aaa721d0d7067a95e94.html">fnal</a></li><li class="navelem"><a class="el" href="dir_5fb6c0d865c8e3c0cb7b32b6001c3eea.html">ppd</a></li><li class="navelem"><a class="el" href="dir_9d421df149f4cb5ac4aaf6dc794d4959.html">dd</a></li><li class="navelem"><a class="el" href="dir_76f82e8c00622cd4d4d8bf62eb2476e1.html">chat</a></li><li class="navelem"><a class="el" href="MessagingServer_8java.html">MessagingServer.java</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.5 </li>
  </ul>
</div>
</body>
</html>
